<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üïµÔ∏è The Mole - Multiplayer</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .title {
            text-align: center;
            font-size: 3rem;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: rgba(15, 52, 96, 0.8);
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem 0;
            border: 2px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .input-group {
            margin: 1rem 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .input-group input::placeholder, .input-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-primary { background: linear-gradient(45deg, #27ae60, #2ecc71); }
        .btn-danger { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .btn-warning { background: linear-gradient(45deg, #f39c12, #e67e22); }
        .btn-info { background: linear-gradient(45deg, #8e44ad, #9b59b6); }
        .btn-secondary { background: linear-gradient(45deg, #95a5a6, #7f8c8d); }
        .btn-bot { background: linear-gradient(45deg, #16a085, #1abc9c); }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn:disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .player-card {
            background: rgba(52, 73, 94, 0.8);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .player-card.host {
            border-color: #f39c12;
        }

        .player-card.ready {
            border-color: #27ae60;
        }

        .player-card.current-turn {
            border-color: #e74c3c;
            animation: pulse 2s infinite;
        }

        .player-card.bot {
            border-color: #1abc9c;
            background: rgba(22, 160, 133, 0.3);
        }

        .kick-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(231, 76, 60, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .player-card:hover .kick-btn {
            display: block;
        }

        .kick-btn:hover {
            background: rgba(231, 76, 60, 1);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .info-card {
            background: rgba(52, 73, 94, 0.6);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }

        .question-section {
            background: rgba(26, 26, 46, 0.8);
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .ready-to-vote-section {
            background: rgba(241, 196, 15, 0.2);
            border: 2px solid #f1c40f;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .ready-to-vote-section p {
            margin: 0 0 10px 0;
            font-weight: bold;
            color: #f1c40f;
        }

        .ready-to-vote-section .ready-count {
            font-size: 1.2em;
            color: #fff;
            margin: 10px 0;
        }

        .game-log {
            background: rgba(52, 73, 94, 0.4);
            padding: 1rem;
            border-radius: 10px;
            height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            margin: 0.5rem 0;
            padding: 0.5rem;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.05);
        }

        .voting-section {
            background: rgba(231, 76, 60, 0.2);
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
            border: 2px solid rgba(231, 76, 60, 0.5);
        }

        .locations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.4rem;
            margin: 1rem 0;
            font-size: 0.8rem;
            max-height: 150px;
            overflow-y: auto;
        }

        .location-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem;
            border-radius: 5px;
            text-align: center;
        }

        .error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .success {
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid #27ae60;
            color: #27ae60;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .warning {
            background: rgba(243, 156, 18, 0.2);
            border: 1px solid #f39c12;
            color: #f39c12;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .info {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
            color: #3498db;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .role-display {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin: 1rem 0;
        }

        .role-imposter {
            background: rgba(231, 76, 60, 0.3);
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }

        .role-location {
            background: rgba(39, 174, 96, 0.3);
            border: 2px solid #27ae60;
            color: #27ae60;
        }

        .lock-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-left: 1rem;
        }

        .lock-status.locked {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }

        .lock-status.unlocked {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
            border: 1px solid #27ae60;
        }

        /* NEW: Bot controls styling */
        .bot-controls {
            background: rgba(22, 160, 133, 0.2);
            border: 2px solid #1abc9c;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .bot-controls h3 {
            color: #1abc9c;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bot-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .bot-warning {
            background: rgba(243, 156, 18, 0.2);
            border: 1px solid #f39c12;
            color: #f39c12;
            padding: 0.75rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        .scoreboard {
            background: rgba(15, 52, 96, 0.8);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .scoreboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .scoreboard-table th,
        .scoreboard-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scoreboard-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .scoreboard-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .rank {
            font-weight: bold;
            color: #f39c12;
        }

        .rank.first { color: #f1c40f; }
        .rank.second { color: #95a5a6; }
        .rank.third { color: #e67e22; }

        .player-name {
            font-weight: bold;
        }

        .player-name.offline {
            opacity: 0.6;
            font-style: italic;
        }

        .player-name.bot {
            color: #1abc9c;
        }

        .score {
            font-weight: bold;
            color: #27ae60;
            font-size: 1.1rem;
        }

        .scoreboard-tabs {
            display: flex;
            margin-bottom: 1rem;
        }

        .tab-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            margin-right: 0.5rem;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: rgba(52, 152, 219, 0.6);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .game-history {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .round-summary {
            background: rgba(39, 174, 96, 0.2);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid rgba(39, 174, 96, 0.4);
        }

        .round-summary h4 {
            color: #27ae60;
            margin-bottom: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 2rem;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content.large {
            max-width: 800px;
        }

        .question-status-waiting {
            color: #f39c12 !important;
        }

        .question-status-asked {
            color: #e74c3c !important;
        }

        .question-status-ready {
            color: #27ae60 !important;
        }

        .question-status-asking {
            color: #3498db !important;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
            
            .game-info {
                grid-template-columns: 1fr;
            }

            .bot-status {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">üïµÔ∏è THE MOLE - Multiplayer</h1>

        <!-- Home Screen -->
        <div id="home-screen" class="screen active">
            <div class="card">
                <h2>Welcome to The Mole!</h2>
                <p>Find the imposter among your friends in this exciting deduction game.</p>
                
                <div class="input-group">
                    <label>Your Name:</label>
                    <input type="text" id="player-name" placeholder="Enter your name" maxlength="20">
                </div>

                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="createRoom()">üéÆ Create Room</button>
                    <button class="btn btn-warning" onclick="showJoinRoom()">üö™ Join Room</button>
                </div>

                <div id="join-room-section" style="display: none; margin-top: 1rem;">
                    <div class="input-group">
                        <label>Room Code:</label>
                        <input type="text" id="room-code" placeholder="Enter room code" maxlength="6">
                    </div>
                    <button class="btn btn-primary" onclick="joinRoom()">Join</button>
                </div>
            </div>

            <div class="card">
                <h3>üìç Possible Locations:</h3>
                <div class="locations-grid" id="locations-list"></div>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="screen">
            <div class="card">
                <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                    <h2>Room: <span id="room-display"></span></h2>
                    <div id="lock-status" class="lock-status unlocked">
                        üîì Open
                    </div>
                </div>
                <div id="lobby-players" class="players-list"></div>
                
                <!-- NEW: Bot Controls Section -->
                <div id="bot-controls" class="bot-controls">
                    <h3>ü§ñ Bot Management</h3>
                    <div class="bot-status">
                        <span>Bots in room: <strong id="bot-count">0</strong></span>
                        <div>
                            <button id="add-bot-btn" class="btn btn-bot" onclick="addBot()">ü§ñ Add Bot</button>
                            <button id="remove-all-bots-btn" class="btn btn-secondary" onclick="removeAllBots()" style="display: none;">Remove All Bots</button>
                        </div>
                    </div>
                    <div id="bot-warning" class="bot-warning" style="display: none;">
                        ‚ö†Ô∏è Bots will be automatically removed if you set custom locations
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button id="ready-btn" class="btn btn-warning" onclick="toggleReady()">Ready Up</button>
                    <button id="start-btn" class="btn btn-primary" onclick="startGame()" style="display: none;">üéÆ Start Game</button>
                    <button id="lock-btn" class="btn btn-secondary" onclick="toggleLock()" style="display: none;">üîí Lock Room</button>
                    <button id="custom-locations-btn" class="btn btn-info" onclick="showCustomLocations()" style="display: none;">üéØ Custom Locations</button>
                    <button class="btn btn-info" onclick="showScoreboard()">üìä Scoreboard</button>
                </div>
            </div>

            <div class="scoreboard">
                <h3>üèÜ Room Scoreboard</h3>
                <div id="lobby-scoreboard-content">
                    <p>No games played yet. Start your first game!</p>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="game-info">
                <div class="info-card">
                    <h3>Game Status</h3>
                    <p>Round: <span id="current-round">1</span></p>
                    <p>Questions: <span id="questions-count">0/5</span></p>
                    <p>Turn: <span id="current-turn">-</span></p>
                </div>
                
                <div class="info-card">
                    <h3>Players</h3>
                    <div id="game-players" class="players-list"></div>
                </div>

                <div class="info-card">
                    <h3>üìç Possible Locations</h3>
                    <div id="game-locations-list" class="locations-grid"></div>
                </div>
            </div>

            <div id="role-display" class="role-display"></div>

            <div class="question-section">
                <h3>‚ùì Current Question</h3>
                <div id="current-question" style="margin: 1rem 0; font-style: italic;">Waiting for question...</div>
                
                <div id="ask-section" style="display: none;">
                    <div class="input-group">
                        <label>Ask:</label>
                        <select id="target-select">
                            <option value="">Select player to ask</option>
                        </select>
                    </div>
                    <button id="ask-question-btn" class="btn btn-primary" onclick="askQuestion()">üé≤ Ask Question</button>
                    <div id="question-status" style="margin-top: 0.5rem; font-style: italic; color: rgba(255,255,255,0.7); display: none;">
                        <!-- Status messages will appear here -->
                    </div>
                </div>

                <div id="imposter-reveal-section" style="display: none;">
                    <button class="btn btn-danger" onclick="showImposterReveal()">üé≠ Reveal as Imposter</button>
                </div>
            </div>

            <div id="ready-to-vote-section" class="ready-to-vote-section" style="display: none;">
                <p>üó≥Ô∏è Ready to start voting?</p>
                <div class="ready-count" id="ready-count-display">0 players ready</div>
                <p>At least <span id="required-count">2</span> players need to be ready before voting begins.</p>
                <button id="ready-to-vote-btn" class="btn btn-warning" onclick="readyToVote()">I'm Ready to Vote!</button>
            </div>

            <div id="voting-section" class="voting-section" style="display: none;">
                <h3>üó≥Ô∏è Vote for the Imposter</h3>
                <p>Choose who you think is the imposter:</p>
                <div id="vote-options"></div>
            </div>

            <div class="scoreboard">
                <h3>üìä Current Scores</h3>
                <div id="game-scoreboard-content"></div>
                <button class="btn btn-info" onclick="showScoreboard()">View Full Scoreboard</button>
            </div>

            <div class="game-log" id="game-log"></div>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="screen">
            <div class="card">
                <h2>üèÅ Game Over!</h2>
                <div id="game-result"></div>
                <div id="game-summary"></div>
                <button class="btn btn-primary" onclick="backToLobby()">Back to Lobby</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="answer-modal" class="modal">
        <div class="modal-content">
            <h3>Answer the Question</h3>
            <div id="modal-question"></div>
            <div class="input-group">
                <label>Your Answer:</label>
                <textarea id="answer-input" rows="4" placeholder="Type your answer here..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="submitAnswer()">Submit Answer</button>
        </div>
    </div>

    <div id="imposter-modal" class="modal">
        <div class="modal-content">
            <h3>üé≠ Imposter Reveal!</h3>
            <p>You're revealing as the imposter. What location do you think it is?</p>
            <div class="input-group">
                <label>Location Guess:</label>
                <select id="location-guess">
                    <option value="">Select location</option>
                </select>
            </div>
            <button class="btn btn-danger" onclick="submitImposterReveal()">Submit Guess</button>
        </div>
    </div>

    <div id="scoreboard-modal" class="modal">
        <div class="modal-content large">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>üèÜ Detailed Scoreboard</h3>
                <button class="btn btn-warning" onclick="hideScoreboard()" style="margin-left: auto;">‚úï Close</button>
            </div>
            
            <div class="scoreboard-tabs">
                <button class="tab-btn active" onclick="switchTab('current')">Current Scores</button>
                <button class="tab-btn" onclick="switchTab('history')">Game History</button>
                <button class="tab-btn" onclick="switchTab('stats')">Detailed Stats</button>
            </div>

            <div id="current-tab" class="tab-content active">
                <div id="detailed-scoreboard"></div>
            </div>

            <div id="history-tab" class="tab-content">
                <div id="game-history-content"></div>
            </div>

            <div id="stats-tab" class="tab-content">
                <div id="detailed-stats-content"></div>
            </div>
        </div>
    </div>

    <div id="custom-locations-modal" class="modal">
        <div class="modal-content">
            <h3>üéØ Custom Locations</h3>
            <p>Enter your custom locations separated by commas. Leave empty to use default locations.</p>
            <div class="bot-warning">
                ‚ö†Ô∏è Setting custom locations will remove all bots from the room
            </div>
            <div class="input-group">
                <label>Custom Locations:</label>
                <textarea id="custom-locations-input" rows="6" placeholder="Space Station, Underwater Lab, Haunted House, Secret Base, etc."></textarea>
            </div>
            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="setCustomLocations()">Set Custom Locations</button>
                <button class="btn btn-warning" onclick="hideCustomLocations()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="round-summary-modal" class="modal">
        <div class="modal-content">
            <h3>üìä Round Summary</h3>
            <div id="round-summary-content"></div>
            <button class="btn btn-primary" onclick="hideRoundSummary()">Continue</button>
        </div>
    </div>

    <script>
        const socket = io();
        let gameState = {};
        let currentRoom = '';
        let isHost = false;
        let playerName = '';
        let actualPlayerName = '';
        let isReady = false;
        let scoreboardData = [];
        let gameHistory = [];
        let roundEndScoreboard = null;
        let hasClickedReadyToVote = false;
        let customLocations = [];
        let isRoomLocked = false;
        let botCount = 0; // NEW: Track bot count
        let usingCustomLocations = false; // NEW: Track if using custom locations

        const locations = [
            "Circus", "Amusement Park", "Crashing Airplane", "Titanic",
            "Burning Orphanage", "Dingy Motel Drug Deal", "Prison", "Safari",
            "Zombie Apocalypse", "Organ-Harvesting Hospital", "Nuclear Submarine",
            "Daycare", "Amazon Rainforest", "Concert Hall", "Space Station",
            "High School", "Haunted Mansion", "Beach"
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const locationsList = document.getElementById('locations-list');
            locations.forEach(location => {
                const div = document.createElement('div');
                div.className = 'location-item';
                div.textContent = location;
                locationsList.appendChild(div);
            });

            updateImposterModalLocations();
        });

        function updateImposterModalLocations() {
            const locationGuessSelect = document.getElementById('location-guess');
            locationGuessSelect.innerHTML = '<option value="">Select location</option>';
            
            const locationsToUse = customLocations.length > 0 ? customLocations : locations;
            locationsToUse.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationGuessSelect.appendChild(option);
            });
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function createRoom() {
            playerName = document.getElementById('player-name').value.trim();
            if (!playerName) {
                showError('Please enter your name');
                return;
            }
            socket.emit('create_room', playerName);
        }

        function showJoinRoom() {
            document.getElementById('join-room-section').style.display = 'block';
        }

        function joinRoom() {
            playerName = document.getElementById('player-name').value.trim();
            const roomCode = document.getElementById('room-code').value.trim().toUpperCase();
            
            if (!playerName || !roomCode) {
                showError('Please enter your name and room code');
                return;
            }
            
            socket.emit('join_room', { roomCode, playerName });
        }

        function toggleReady() {
            socket.emit('toggle_ready');
        }

        function toggleLock() {
            if (!isHost) return;
            socket.emit('toggle_lock');
        }

        function kickPlayer(targetId) {
            if (!isHost) return;
            
            if (confirm('Are you sure you want to kick this player?')) {
                socket.emit('kick_player', { targetId });
            }
        }

        // NEW: Bot management functions
        function addBot() {
            if (!isHost) {
                showError('Only the host can add bots');
                return;
            }
            
            // Get current total player count
            const totalPlayers = document.querySelectorAll('.player-card').length;
            
            if (totalPlayers >= 8) {
                showError('Room is full (8/8 players)');
                return;
            }
            
            if (usingCustomLocations) {
                showError('Cannot add bots when using custom locations');
                return;
            }
            
            socket.emit('add_bot', { difficulty: 'medium' });
        }

        function removeBot(botId) {
            if (!isHost) return;
            
            if (confirm('Are you sure you want to remove this bot?')) {
                socket.emit('remove_bot', { botId });
            }
        }

        function removeAllBots() {
            if (!isHost) return;
            
            if (confirm('Are you sure you want to remove all bots?')) {
                // Get all bot IDs and remove them one by one
                const players = document.querySelectorAll('.player-card.bot');
                players.forEach(playerCard => {
                    const kickBtn = playerCard.querySelector('.kick-btn');
                    if (kickBtn) {
                        kickBtn.click();
                    }
                });
            }
        }

        function updateBotControls() {
            const botControls = document.getElementById('bot-controls');
            const botCountSpan = document.getElementById('bot-count');
            const addBotBtn = document.getElementById('add-bot-btn');
            const removeAllBotsBtn = document.getElementById('remove-all-bots-btn');
            const botWarning = document.getElementById('bot-warning');
            
            if (isHost) {
                botControls.style.display = 'block';
                botCountSpan.textContent = botCount;
                
                // Get total player count from the lobby
                const totalPlayers = document.querySelectorAll('.player-card').length;
                
                // Show/hide add bot button based on conditions
                const canAddBot = totalPlayers < 8 && !usingCustomLocations;
                addBotBtn.style.display = 'inline-block'; // Always show the button
                addBotBtn.disabled = !canAddBot;
                
                // Update button text based on state
                if (totalPlayers >= 8) {
                    addBotBtn.textContent = 'ü§ñ Room Full (8/8)';
                } else if (usingCustomLocations) {
                    addBotBtn.textContent = 'ü§ñ Disabled (Custom Locations)';
                } else {
                    addBotBtn.textContent = `ü§ñ Add Bot (${totalPlayers}/8)`;
                }
                
                // Show/hide remove all bots button
                removeAllBotsBtn.style.display = botCount > 0 ? 'inline-block' : 'none';
                
                // Show warning if using custom locations
                botWarning.style.display = usingCustomLocations ? 'block' : 'none';
            } else {
                botControls.style.display = 'none';
            }
        }

        function startGame() {
            if (!isHost) return;
            
            if (customLocations.length > 0) {
                socket.emit('start_game', { customLocations });
            } else {
                socket.emit('start_game');
            }
        }

        function askQuestion() {
            const targetId = document.getElementById('target-select').value;
            if (!targetId) {
                showError('Please select a player to ask');
                return;
            }

            updateQuestionStatus('asking', 'Sending question...');
            socket.emit('ask_question', { targetId });
        }

        function submitAnswer() {
            const answer = document.getElementById('answer-input').value.trim();
            if (!answer) {
                showError('Please provide an answer');
                return;
            }

            const { asker, target, question } = gameState.currentQuestion;
            socket.emit('submit_answer', { asker, target, question, answer });
            
            document.getElementById('answer-input').value = '';
            hideModal('answer-modal');
        }

        function readyToVote() {
            if (hasClickedReadyToVote) {
                showError('You have already indicated you are ready to vote');
                return;
            }
            
            socket.emit('ready_to_vote');
            hasClickedReadyToVote = true;
            
            const btn = document.getElementById('ready-to-vote-btn');
            btn.textContent = 'Ready! Waiting for others...';
            btn.disabled = true;
            btn.className = 'btn btn-primary';
        }

        function submitVote(targetId) {
            console.log('Submitting vote for:', targetId);
            socket.emit('submit_vote', { targetId });
            document.getElementById('voting-section').style.display = 'none';
        }

        function showImposterReveal() {
            updateImposterModalLocations();
            showModal('imposter-modal');
        }

        function submitImposterReveal() {
            const locationGuess = document.getElementById('location-guess').value;
            if (!locationGuess) {
                showError('Please select a location');
                return;
            }
            
            socket.emit('imposter_reveal', { locationGuess });
            hideModal('imposter-modal');
        }

        function updateGameLocations() {
            const gameLocationsList = document.getElementById('game-locations-list');
            gameLocationsList.innerHTML = '';
            
            const locationsToShow = customLocations.length > 0 ? customLocations : locations;
            locationsToShow.forEach(location => {
                const div = document.createElement('div');
                div.className = 'location-item';
                div.textContent = location;
                gameLocationsList.appendChild(div);
            });
        }

        function backToLobby() {
            showScreen('lobby-screen');
            gameState = {};
            hasClickedReadyToVote = false;
            setTimeout(() => {
                socket.emit('request_scoreboard');
            }, 500);
        }

        function updateQuestionStatus(status, message) {
            const statusElement = document.getElementById('question-status');
            const askBtn = document.getElementById('ask-question-btn');
            
            if (statusElement) {
                statusElement.style.display = 'block';
                statusElement.className = `question-status-${status}`;
                statusElement.textContent = message;
            }
            
            if (askBtn) {
                switch(status) {
                    case 'ready':
                        askBtn.disabled = false;
                        askBtn.textContent = 'üé≤ Ask Question';
                        break;
                    case 'asking':
                        askBtn.disabled = true;
                        askBtn.textContent = 'Asking...';
                        break;
                    case 'waiting':
                        askBtn.disabled = true;
                        askBtn.textContent = 'Waiting for answer...';
                        break;
                    case 'asked':
                        askBtn.disabled = true;
                        askBtn.textContent = 'Question asked this turn';
                        break;
                }
            }
        }

        function showScoreboard() {
            socket.emit('request_scoreboard');
            showModal('scoreboard-modal');
        }

        function hideScoreboard() {
            hideModal('scoreboard-modal');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-btn:nth-child(${tabName === 'current' ? 1 : tabName === 'history' ? 2 : 3})`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function showRoundSummary(summaryData) {
            document.getElementById('round-summary-content').innerHTML = summaryData;
            showModal('round-summary-modal');
        }

        function hideRoundSummary() {
            hideModal('round-summary-modal');
        }

        function showCustomLocations() {
            showModal('custom-locations-modal');
        }

        function hideCustomLocations() {
            hideModal('custom-locations-modal');
        }

        function setCustomLocations() {
            const input = document.getElementById('custom-locations-input').value.trim();
            
            if (input) {
                customLocations = input.split(',')
                    .map(loc => loc.trim())
                    .filter(loc => loc.length > 0);
                
                if (customLocations.length < 3) {
                    showError('Please provide at least 3 custom locations');
                    return;
                }
                
                showSuccess(`Custom locations set: ${customLocations.length} locations`);
                updateImposterModalLocations();
            } else {
                customLocations = [];
                showSuccess('Using default locations');
                updateImposterModalLocations();
            }
            
            hideCustomLocations();
        }

        function updateLockStatus(isLocked) {
            isRoomLocked = isLocked;
            const lockStatus = document.getElementById('lock-status');
            const lockBtn = document.getElementById('lock-btn');
            
            if (isLocked) {
                lockStatus.className = 'lock-status locked';
                lockStatus.innerHTML = 'üîí Locked';
                if (lockBtn) lockBtn.textContent = 'üîì Unlock Room';
            } else {
                lockStatus.className = 'lock-status unlocked';
                lockStatus.innerHTML = 'üîì Open';
                if (lockBtn) lockBtn.textContent = 'üîí Lock Room';
            }
        }

        // Socket event handlers
        socket.on('room_created', (data) => {
            currentRoom = data.roomCode;
            isHost = data.isHost;
            actualPlayerName = data.actualName;
            playerName = actualPlayerName;
            document.getElementById('room-display').textContent = currentRoom;
            showScreen('lobby-screen');
            showSuccess(`Room created! Code: ${currentRoom}`);
        });

        socket.on('room_joined', (data) => {
            currentRoom = data.roomCode;
            isHost = data.isHost;
            actualPlayerName = data.actualName;
            playerName = actualPlayerName;
            document.getElementById('room-display').textContent = currentRoom;
            showScreen('lobby-screen');
            showSuccess(`Joined room: ${currentRoom}`);
        });

        socket.on('name_changed', (data) => {
            showWarning(`Your name was changed from "${data.originalName}" to "${data.newName}" because that name was already taken.`);
        });

        socket.on('room_lock_changed', (data) => {
            updateLockStatus(data.isLocked);
            showInfo(data.message);
        });

        socket.on('kicked', (data) => {
            showError(data.message);
            showScreen('home-screen');
            currentRoom = '';
            isHost = false;
            playerName = '';
            actualPlayerName = '';
        });

        // NEW: Bot event handlers
        socket.on('bot_added', (data) => {
            showSuccess(`Bot ${data.botName} added to the room`);
            botCount = data.botCount;
            updateBotControls();
        });

        socket.on('bot_removed', (data) => {
            showInfo(`Bot ${data.botName} removed from the room`);
            botCount = data.botCount;
            updateBotControls();
        });

        socket.on('bots_removed_custom_locations', (data) => {
            showWarning(`${data.removedBots.length} bots removed: ${data.removedBots.join(', ')}`);
            showInfo(data.message);
            botCount = 0;
            updateBotControls();
        });

        socket.on('player_kicked', (data) => {
            if (data.wasBot) {
                showInfo(`Bot ${data.kickedPlayerName} was removed`);
                botCount = data.botCount;
            } else {
                showInfo(`${data.kickedPlayerName} was kicked from the room`);
            }
            updateLobbyPlayers(data.players);
            if (data.scoreboard) {
                updateLobbyScoreboard(data.scoreboard);
            }
            updateLockStatus(data.isLocked);
            updateBotControls();
        });

        socket.on('room_updated', (data) => {
            updateLobbyPlayers(data.players);
            if (data.scoreboard) {
                updateLobbyScoreboard(data.scoreboard);
            }
            if (data.hasOwnProperty('isLocked')) {
                updateLockStatus(data.isLocked);
            }
            if (data.hasOwnProperty('botCount')) {
                botCount = data.botCount;
            }
            if (data.hasOwnProperty('usingCustomLocations')) {
                usingCustomLocations = data.usingCustomLocations;
            }
            updateBotControls();
        });

        socket.on('player_left', (data) => {
            showInfo(`${data.playerName} left the room`);
            updateLobbyPlayers(data.players);
            if (data.scoreboard) {
                updateLobbyScoreboard(data.scoreboard);
            }
            if (data.hasOwnProperty('isLocked')) {
                updateLockStatus(data.isLocked);
            }
            if (data.hasOwnProperty('botCount')) {
                botCount = data.botCount;
            }
            updateBotControls();
        });

        socket.on('game_started', (data) => {
            gameState = data;
            hasClickedReadyToVote = false;
            
            if (data.scoreboard) {
                scoreboardData = data.scoreboard;
            }
            showScreen('game-screen');
            updateGameDisplay();
            updateGameLocations();
            addToLog('üéÆ Game started!');
            
            if (data.isImposter) {
                addToLog('üé≠ You are the IMPOSTER!');
            } else {
                addToLog(`üìç Location: ${data.playerRole}`);
            }
        });

        socket.on('question_asked', (data) => {
            gameState.currentQuestion = data;
            gameState.questionAskedThisTurn = true;
            gameState.waitingForAnswer = true;
            
            document.getElementById('current-question').innerHTML = 
                `<strong>${data.asker}</strong> asks <strong>${data.target}</strong>: "${data.question}"`;
            
            addToLog(`‚ùì ${data.asker} asks ${data.target}: ${data.question}`);
            
            updateGameDisplay();
            
            if (data.targetId === socket.id) {
                document.getElementById('modal-question').innerHTML = 
                    `<strong>${data.asker}</strong> asks: "${data.question}"`;
                showModal('answer-modal');
                document.getElementById('answer-input').focus();
            }
        });

        socket.on('answer_submitted', (data) => {
            addToLog(`üí¨ ${data.target}: ${data.answer}`);
            
            if (gameState.currentQuestion && gameState.currentQuestion.asker === playerName) {
                gameState.questionAskedThisTurn = false;
                gameState.waitingForAnswer = false;
                updateQuestionStatus('ready', 'Answer received! You can ask another question if it\'s still your turn.');
            }
        });

        socket.on('game_updated', (data) => {
            console.log('Game updated:', data.status, 'Round:', data.currentRound, 'Current turn:', data.currentTurn);
            gameState = { ...gameState, ...data };
            if (data.scoreboard) {
                scoreboardData = data.scoreboard;
            }
            updateGameDisplay();
            
            if (data.status === 'voting') {
                showVotingSection();
            } else if (data.status === 'ended') {
                showGameOver();
            }
        });

        socket.on('vote_submitted', (data) => {
            addToLog(`üó≥Ô∏è ${data.voter} voted (${data.votesReceived}/${data.totalPlayers})`);
            
            if (data.votesReceived === data.totalPlayers) {
                roundEndScoreboard = {
                    round: gameState.currentRound,
                    scoreboard: [...scoreboardData]
                };
            }
        });

        socket.on('ready_count_updated', (data) => {
            addToLog(`üó≥Ô∏è ${data.readyCount}/${data.requiredCount} players ready to vote`);
            
            if (gameState.status === 'playing') {
                gameState.readyToVoteCount = data.readyCount;
                updateGameDisplay();
            }
        });

        socket.on('all_votes_received', () => {
            addToLog('üó≥Ô∏è All votes received! Processing results...');
        });

        socket.on('game_over', (result) => {
            console.log('Game over event received:', result);
            addToLog(`üèÅ ${result.message}`);
            
            const YOUR_NAME = "Jace"; // <-- Change this to your player name
            if (playerName === YOUR_NAME) {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = '/download-all-games';
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    console.log(`üì• Game data automatically downloaded for ${YOUR_NAME}`);
                }, 1500);
            }
        });

        socket.on('scoreboard_updated', (data) => {
            scoreboardData = data.scoreboard || [];
            gameHistory = data.gameHistory || [];
            updateDetailedScoreboard();
        });

        socket.on('error', (message) => {
            showError(message);
        });

        function updateLobbyPlayers(players) {
            const container = document.getElementById('lobby-players');
            container.innerHTML = '';
            
            players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-card';
                if (player.isHost) div.classList.add('host');
                if (player.isReady) div.classList.add('ready');
                if (player.isBot) div.classList.add('bot');
                
                let kickButton = '';
                if (isHost && !player.isHost) {
                    kickButton = `<button class="kick-btn" onclick="${player.isBot ? 'removeBot' : 'kickPlayer'}('${player.id}')" title="${player.isBot ? 'Remove bot' : 'Kick player'}">‚úï</button>`;
                }
                
                let statusText = '';
                if (player.isHost) {
                    statusText = 'üëë Host';
                } else if (player.isBot) {
                    statusText = 'ü§ñ Bot';
                } else {
                    statusText = player.isReady ? '‚úÖ Ready' : '‚è≥ Not Ready';
                }
                
                div.innerHTML = `
                    ${kickButton}
                    <div><strong>${player.name}</strong></div>
                    <div>${statusText}</div>
                `;
                container.appendChild(div);
            });

            const readyBtn = document.getElementById('ready-btn');
            const startBtn = document.getElementById('start-btn');
            const lockBtn = document.getElementById('lock-btn');
            const customLocationsBtn = document.getElementById('custom-locations-btn');
            
            if (isHost) {
                const humanPlayers = players.filter(p => !p.isBot);
                const allHumansReady = humanPlayers.filter(p => !p.isHost).every(p => p.isReady);
                const hasEnoughPlayers = players.length >= 3;
                
                startBtn.style.display = (allHumansReady && hasEnoughPlayers) ? 'inline-block' : 'none';
                lockBtn.style.display = 'inline-block';
                customLocationsBtn.style.display = 'inline-block';
                readyBtn.style.display = 'none';
            } else {
                const currentPlayer = players.find(p => p.name === actualPlayerName);
                readyBtn.textContent = currentPlayer?.isReady ? 'Cancel Ready' : 'Ready Up';
                readyBtn.className = `btn ${currentPlayer?.isReady ? 'btn-warning' : 'btn-primary'}`;
                startBtn.style.display = 'none';
                lockBtn.style.display = 'none';
                customLocationsBtn.style.display = 'none';
            }
            
            updateBotControls();
        }

        function updateLobbyScoreboard(scoreboard) {
            const container = document.getElementById('lobby-scoreboard-content');
            
            if (!scoreboard || scoreboard.length === 0) {
                container.innerHTML = '<p>No games played yet. Start your first game!</p>';
                return;
            }

            const topPlayers = scoreboard.slice(0, 5);
            let html = '<div class="scoreboard-table">';
            html += '<table style="width: 100%;">';
            html += '<thead><tr><th>Rank</th><th>Player</th><th>Score</th><th>Games Won</th></tr></thead>';
            html += '<tbody>';
            
            topPlayers.forEach((player, index) => {
                const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
                let playerClass = '';
                if (!player.isOnline) playerClass += 'offline ';
                if (player.isBot) playerClass += 'bot ';
                
                html += `
                    <tr>
                        <td><span class="rank ${rankClass}">#${index + 1}</span></td>
                        <td><span class="player-name ${playerClass}">${player.name}${player.isBot ? ' ü§ñ' : ''}</span></td>
                        <td><span class="score">${player.score}</span></td>
                        <td>${player.gamesWon}/${player.gamesPlayed}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function updateGameDisplay() {
            if (!gameState.playerOrder) return;

            document.getElementById('current-round').textContent = gameState.currentRound || 1;
            document.getElementById('questions-count').textContent = 
                `${gameState.questionsThisRound || 0}/${gameState.questionsPerRound || 5}`;
            
            const currentPlayerIndex = gameState.currentTurn || 0;
            const currentPlayer = gameState.playerOrder[currentPlayerIndex];
            document.getElementById('current-turn').textContent = currentPlayer?.name || '-';

            const roleDisplay = document.getElementById('role-display');
            if (gameState.isImposter) {
                roleDisplay.className = 'role-display role-imposter';
                roleDisplay.innerHTML = 'üé≠ You are the IMPOSTER!<br>Find out the location!';
                document.getElementById('imposter-reveal-section').style.display = 'block';
            } else if (gameState.playerRole) {
                roleDisplay.className = 'role-display role-location';
                roleDisplay.innerHTML = `üìç Location: <strong>${gameState.playerRole}</strong><br>Find the imposter!`;
                document.getElementById('imposter-reveal-section').style.display = 'none';
            }

            const playersContainer = document.getElementById('game-players');
            playersContainer.innerHTML = '';
            
            gameState.playerOrder?.forEach((player, index) => {
                const div = document.createElement('div');
                div.className = 'player-card';
                if (index === gameState.currentTurn) div.classList.add('current-turn');
                if (player.isBot) div.classList.add('bot');
                
                div.innerHTML = `<strong>${player.name}${player.isBot ? ' ü§ñ' : ''}</strong>`;
                playersContainer.appendChild(div);
            });

            const targetSelect = document.getElementById('target-select');
            targetSelect.innerHTML = '<option value="">Select player to ask</option>';
            
            gameState.playerOrder?.forEach(player => {
                if (!player.isYou) {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = `${player.name}${player.isBot ? ' ü§ñ' : ''}`;
                    targetSelect.appendChild(option);
                }
            });

            const askSection = document.getElementById('ask-section');
            const isMyTurn = gameState.playerOrder?.[gameState.currentTurn]?.isYou;
            
            askSection.style.display = (isMyTurn && gameState.status === 'playing') ? 'block' : 'none';

            if (isMyTurn && gameState.status === 'playing') {
                if (gameState.waitingForAnswer) {
                    updateQuestionStatus('waiting', 'Waiting for answer to your question...');
                } else if (gameState.questionAskedThisTurn) {
                    updateQuestionStatus('asked', 'You have already asked a question this turn.');
                } else {
                    updateQuestionStatus('ready', 'Your turn! Select a player and ask a question.');
                }
            } else {
                document.getElementById('question-status').style.display = 'none';
            }

            const readyToVoteSection = document.getElementById('ready-to-vote-section');
            const readyCountDisplay = document.getElementById('ready-count-display');
            const requiredCountSpan = document.getElementById('required-count');
            const readyToVoteBtn = document.getElementById('ready-to-vote-btn');

            if (gameState.status === 'playing' && gameState.questionsThisRound >= gameState.questionsPerRound) {
                readyToVoteSection.style.display = 'block';
                
                const readyCount = gameState.readyToVoteCount || 0;
                const requiredCount = (gameState.playerOrder?.length || 2) - 1;
                
                readyCountDisplay.textContent = `${readyCount}/${requiredCount} players ready`;
                requiredCountSpan.textContent = requiredCount;
                
                if (hasClickedReadyToVote) {
                    readyToVoteBtn.textContent = 'Ready! Waiting for others...';
                    readyToVoteBtn.disabled = true;
                    readyToVoteBtn.className = 'btn btn-primary';
                } else {
                    readyToVoteBtn.textContent = "I'm Ready to Vote!";
                    readyToVoteBtn.disabled = false;
                    readyToVoteBtn.className = 'btn btn-warning';
                }
            } else {
                readyToVoteSection.style.display = 'none';
            }

            updateGameScoreboard();
        }

        function updateGameScoreboard() {
            const container = document.getElementById('game-scoreboard-content');
            
            if (!scoreboardData || scoreboardData.length === 0) {
                container.innerHTML = '<p>Scoreboard will update after the round...</p>';
                return;
            }

            const topPlayers = scoreboardData.slice(0, 3);
            let html = '';
            
            topPlayers.forEach((player, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
                const onlineStatus = player.isOnline ? '' : ' (offline)';
                const botStatus = player.isBot ? ' ü§ñ' : '';
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(255,255,255,0.05); margin: 0.25rem 0; border-radius: 5px;">
                        <span>${medal} ${player.name}${botStatus}${onlineStatus}</span>
                        <span class="score">${player.score}</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateDetailedScoreboard() {
            const currentTab = document.getElementById('detailed-scoreboard');
            if (scoreboardData.length === 0) {
                currentTab.innerHTML = '<p>No data available yet.</p>';
            } else {
                let html = '<table class="scoreboard-table">';
                html += '<thead><tr><th>Rank</th><th>Player</th><th>Score</th><th>Games</th><th>Win Rate</th><th>Imposter Rate</th></tr></thead>';
                html += '<tbody>';
                
                scoreboardData.forEach((player, index) => {
                    const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
                    let playerClass = '';
                    if (!player.isOnline) playerClass += 'offline ';
                    if (player.isBot) playerClass += 'bot ';
                    
                    const winRate = player.gamesPlayed > 0 ? ((player.gamesWon / player.gamesPlayed) * 100).toFixed(1) : '0';
                    const imposterRate = player.timesImposter > 0 ? ((player.timesImposterWon / player.timesImposter) * 100).toFixed(1) : '0';
                    
                    html += `
                        <tr>
                            <td><span class="rank ${rankClass}">#${index + 1}</span></td>
                            <td><span class="player-name ${playerClass}">${player.name}${player.isBot ? ' ü§ñ' : ''}</span></td>
                            <td><span class="score">${player.score}</span></td>
                            <td>${player.gamesWon}/${player.gamesPlayed}</td>
                            <td>${winRate}%</td>
                            <td>${imposterRate}%</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                currentTab.innerHTML = html;
            }

            const historyTab = document.getElementById('game-history-content');
            if (gameHistory.length === 0) {
                historyTab.innerHTML = '<p>No games completed yet.</p>';
            } else {
                let html = '<div class="game-history">';
                gameHistory.slice().reverse().forEach(game => {
                    html += `
                        <div class="history-item">
                            <h4>Game #${game.gameNumber} - ${new Date(game.date).toLocaleString()}</h4>
                            <p><strong>Location:</strong> ${game.location}</p>
                            <p><strong>Imposter:</strong> ${game.imposter}</p>
                            <p><strong>Winner:</strong> ${game.winner === 'imposter_wins' ? 'Imposter' : 'Location Team'}</p>
                            <p><strong>Rounds:</strong> ${game.rounds}</p>
                            <details>
                                <summary>Final Scores</summary>
                                ${game.finalScores.map(score => `<p>${score.name}: ${score.score}</p>`).join('')}
                            </details>
                        </div>
                    `;
                });
                html += '</div>';
                historyTab.innerHTML = html;
            }

            const statsTab = document.getElementById('detailed-stats-content');
            if (scoreboardData.length === 0) {
                statsTab.innerHTML = '<p>No stats available yet.</p>';
            } else {
                let html = '<table class="scoreboard-table">';
                html += '<thead><tr><th>Player</th><th>Questions Asked</th><th>Questions Answered</th><th>Vote Accuracy</th><th>Rounds Survived</th></tr></thead>';
                html += '<tbody>';
                
                scoreboardData.forEach(player => {
                    const voteAccuracy = player.totalVotes > 0 ? ((player.correctVotes / player.totalVotes) * 100).toFixed(1) : '0';
                    let playerClass = '';
                    if (!player.isOnline) playerClass += 'offline ';
                    if (player.isBot) playerClass += 'bot ';
                    
                    html += `
                        <tr>
                            <td><span class="player-name ${playerClass}">${player.name}${player.isBot ? ' ü§ñ' : ''}</span></td>
                            <td>${player.questionsAsked}</td>
                            <td>${player.questionsAnswered}</td>
                            <td>${voteAccuracy}% (${player.correctVotes}/${player.totalVotes})</td>
                            <td>${player.roundsSurvived}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                statsTab.innerHTML = html;
            }
        }

        function showVotingSection() {
            const votingSection = document.getElementById('voting-section');
            const voteOptions = document.getElementById('vote-options');
            
            voteOptions.innerHTML = '';
            
            gameState.playerOrder?.forEach(player => {
                if (!player.isYou) {
                    const button = document.createElement('button');
                    button.className = 'btn btn-danger';
                    button.textContent = `${player.name}${player.isBot ? ' ü§ñ' : ''}`;
                    button.onclick = () => submitVote(player.id);
                    voteOptions.appendChild(button);
                }
            });
            
            votingSection.style.display = 'block';
            document.getElementById('ready-to-vote-section').style.display = 'none';
            addToLog('üó≥Ô∏è Voting phase started! Choose who you think is the imposter.');
        }

        function showGameOver() {
            const resultDiv = document.getElementById('game-result');
            const summaryDiv = document.getElementById('game-summary');
            
            if (gameState.gameResult) {
                resultDiv.innerHTML = `
                    <div class="${gameState.gameResult.winner === 'location_wins' ? 'success' : 'error'}">
                        <h3>${gameState.gameResult.message}</h3>
                        <p>Location: ${gameState.gameResult.location}</p>
                        <p>Imposter: ${gameState.gameResult.imposter}</p>
                    </div>
                `;
            }

            if (gameState.gameHistory) {
                let summaryHTML = '<h4>Game Summary:</h4>';
                gameState.gameHistory.forEach(entry => {
                    summaryHTML += `
                        <div class="log-entry">
                            <strong>${entry.asker}</strong> ‚Üí <strong>${entry.target}</strong>: ${entry.question}<br>
                            <em>${entry.answer}</em>
                        </div>
                    `;
                });
                summaryDiv.innerHTML = summaryHTML;
            }

            showScreen('game-over-screen');
        }

        function addToLog(message) {
            const log = document.getElementById('game-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.container').firstChild);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.container').insertBefore(successDiv, document.querySelector('.container').firstChild);
            setTimeout(() => successDiv.remove(), 5000);
        }

        function showWarning(message) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'warning';
            warningDiv.textContent = message;
            document.querySelector('.container').insertBefore(warningDiv, document.querySelector('.container').firstChild);
            setTimeout(() => warningDiv.remove(), 5000);
        }

        function showInfo(message) {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'info';
            infoDiv.textContent = message;
            document.querySelector('.container').insertBefore(infoDiv, document.querySelector('.container').firstChild);
            setTimeout(() => infoDiv.remove(), 3000);
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                if (document.getElementById('answer-modal').classList.contains('active')) {
                    submitAnswer();
                }
            }
        });
    </script>
</body>
</html>
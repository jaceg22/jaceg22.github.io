<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Game Collection - Multiplayer</title>
    <script src="/socket.io/socket.io.js"></script>
    <!-- Add Spotify Web Playback SDK -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .title {
            text-align: center;
            font-size: 3rem;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: rgba(15, 52, 96, 0.8);
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem 0;
            border: 2px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .input-group {
            margin: 1rem 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .input-group input::placeholder, .input-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-primary { background: linear-gradient(45deg, #27ae60, #2ecc71); }
        .btn-danger { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .btn-warning { background: linear-gradient(45deg, #f39c12, #e67e22); }
        .btn-info { background: linear-gradient(45deg, #8e44ad, #9b59b6); }
        .btn-secondary { background: linear-gradient(45deg, #95a5a6, #7f8c8d); }
        .btn-bot { background: linear-gradient(45deg, #16a085, #1abc9c); }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn:disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .player-card {
            background: rgba(52, 73, 94, 0.8);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .player-card.host {
            border-color: #f39c12;
        }

        .player-card.ready {
            border-color: #27ae60;
        }

        .player-card.current-turn {
            border-color: #e74c3c;
            animation: pulse 2s infinite;
        }

        .player-card.bot {
            border-color: #1abc9c;
            background: rgba(22, 160, 133, 0.3);
        }

        .kick-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(231, 76, 60, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .player-card:hover .kick-btn {
            display: block;
        }

        .kick-btn:hover {
            background: rgba(231, 76, 60, 1);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .info-card {
            background: rgba(52, 73, 94, 0.6);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }

        .question-section {
            background: rgba(26, 26, 46, 0.8);
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .ready-to-vote-section {
            background: rgba(241, 196, 15, 0.2);
            border: 2px solid #f1c40f;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .ready-to-vote-section p {
            margin: 0 0 10px 0;
            font-weight: bold;
            color: #f1c40f;
        }

        .ready-to-vote-section .ready-count {
            font-size: 1.2em;
            color: #fff;
            margin: 10px 0;
        }

        .game-log {
            background: rgba(52, 73, 94, 0.4);
            padding: 1rem;
            border-radius: 10px;
            height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            margin: 0.5rem 0;
            padding: 0.5rem;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.05);
        }

        .voting-section {
            background: rgba(231, 76, 60, 0.2);
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
            border: 2px solid rgba(231, 76, 60, 0.5);
        }

        .locations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.4rem;
            margin: 1rem 0;
            font-size: 0.8rem;
            max-height: 150px;
            overflow-y: auto;
        }

        .location-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem;
            border-radius: 5px;
            text-align: center;
        }

        .error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .success {
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid #27ae60;
            color: #27ae60;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .warning {
            background: rgba(243, 156, 18, 0.2);
            border: 1px solid #f39c12;
            color: #f39c12;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .info {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
            color: #3498db;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .role-display {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin: 1rem 0;
        }

        .role-imposter {
            background: rgba(231, 76, 60, 0.3);
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }

        .role-location {
            background: rgba(39, 174, 96, 0.3);
            border: 2px solid #27ae60;
            color: #27ae60;
        }

        .lock-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-left: 1rem;
        }

        .lock-status.locked {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }

        .lock-status.unlocked {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
            border: 1px solid #27ae60;
        }

        .bot-controls {
            background: rgba(22, 160, 133, 0.2);
            border: 2px solid #1abc9c;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .bot-controls h3 {
            color: #1abc9c;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bot-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .bot-warning {
            background: rgba(243, 156, 18, 0.2);
            border: 1px solid #f39c12;
            color: #f39c12;
            padding: 0.75rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        .scoreboard {
            background: rgba(15, 52, 96, 0.8);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .scoreboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .scoreboard-table th,
        .scoreboard-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scoreboard-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .scoreboard-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .rank {
            font-weight: bold;
            color: #f39c12;
        }

        .rank.first { color: #f1c40f; }
        .rank.second { color: #95a5a6; }
        .rank.third { color: #e67e22; }

        .player-name {
            font-weight: bold;
        }

        .player-name.offline {
            opacity: 0.6;
            font-style: italic;
        }

        .player-name.bot {
            color: #1abc9c;
        }

        .score {
            font-weight: bold;
            color: #27ae60;
            font-size: 1.1rem;
        }

        .scoreboard-tabs {
            display: flex;
            margin-bottom: 1rem;
        }

        .tab-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            margin-right: 0.5rem;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: rgba(52, 152, 219, 0.6);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .game-history {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .round-summary {
            background: rgba(39, 174, 96, 0.2);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid rgba(39, 174, 96, 0.4);
        }

        .round-summary h4 {
            color: #27ae60;
            margin-bottom: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 2rem;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content.large {
            max-width: 800px;
        }

        .question-status-waiting {
            color: #f39c12 !important;
        }

        .question-status-asked {
            color: #e74c3c !important;
        }

        .question-status-ready {
            color: #27ae60 !important;
        }

        .question-status-asking {
            color: #3498db !important;
        }

        /* NEW: Game selection styles */
        .game-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .game-option {
            background: rgba(15, 52, 96, 0.8);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .game-option:hover {
            transform: translateY(-5px);
            border-color: rgba(52, 152, 219, 0.6);
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.3);
        }

        .game-option h3 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: #3498db;
        }

        .game-option p {
            margin-bottom: 1.5rem;
            opacity: 0.8;
        }

        .game-option .emoji {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Hint section styles */
        .hint-section {
            background: rgba(26, 26, 46, 0.8);
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        /* NEW: Autocomplete styles for imposter guess input */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-suggestion {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.2s ease;
        }

        .autocomplete-suggestion:hover,
        .autocomplete-suggestion.selected {
            background: rgba(52, 152, 219, 0.3);
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        .imposter-guess-hint {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
            
            .game-info {
                grid-template-columns: 1fr;
            }

            .bot-status {
                flex-direction: column;
                gap: 0.5rem;
            }

            .game-selection {
                grid-template-columns: 1fr;
            }
        }

        /* NEW: Room type styles */
        .room-type-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-left: 1rem;
        }

        .room-type-status.public {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border: 1px solid #3498db;
        }

        .room-type-status.private {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
            border: 1px solid #f39c12;
        }

        .room-type-status.locked {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }

        .room-type-controls {
            background: rgba(52, 73, 94, 0.2);
            border: 2px solid #34495e;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .room-type-controls h3 {
            color: #34495e;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .room-type-options {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .room-type-btn {
            flex: 1;
            min-width: 120px;
            transition: all 0.3s ease;
        }

        .room-type-btn.active {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .room-type-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
            font-style: italic;
        }

        /* Public lobbies styles */
        .public-lobby-item {
            background: rgba(52, 73, 94, 0.8);
            padding: 1rem;
            border-radius: 10px;
            margin: 0.5rem 0;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .public-lobby-item:hover {
            border-color: rgba(52, 152, 219, 0.6);
            transform: translateY(-2px);
        }

        .public-lobby-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .public-lobby-code {
            font-weight: bold;
            font-size: 1.2rem;
            color: #3498db;
        }

        .public-lobby-game-type {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .public-lobby-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .public-lobby-detail {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .public-lobby-detail.bots {
            color: #1abc9c;
        }

        .public-lobby-detail.custom {
            color: #f39c12;
        }

        .public-lobby-detail.players {
            color: #27ae60;
        }

        .public-lobby-detail.time {
            color: #95a5a6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">üéÆ GAME COLLECTION - Multiplayer</h1>

        <!-- NEW: Game Selection Screen -->
        <div id="game-selection-screen" class="screen active">
            <div class="card">
                <h2>Choose Your Game</h2>
                <p>Select which game you'd like to play with your friends!</p>
                
                <div class="input-group">
                    <label>Your Name:</label>
                    <input type="text" id="global-player-name" placeholder="Enter your name" maxlength="20">
                </div>

                <div class="game-selection">
                    <div class="game-option" onclick="selectGame('mole')">
                        <div class="emoji">üïµÔ∏è</div>
                        <h3>The Mole</h3>
                        <p>Find the imposter among locations. Ask questions and vote out the mole!</p>
                        <button class="btn btn-primary">Play The Mole</button>
                    </div>

                    <div class="game-option" onclick="selectGame('nba')">
                        <div class="emoji">üèÄ</div>
                        <h3>NBA Imposter</h3>
                        <p>Guess NBA players by giving hints. Find who doesn't belong!</p>
                        <button class="btn btn-primary">Play NBA Imposter</button>
                    </div>

                    <div class="game-option" onclick="selectGame('rapper')">
                        <div class="emoji">üé§</div>
                        <h3>Rapper Imposter</h3>
                        <p>Guess rappers by giving hints. Find who doesn't know the artist!</p>
                        <button class="btn btn-primary">Play Rapper Imposter</button>
                    </div>
                </div>

                <!-- Spotify Integration on Home -->
                <div style="text-align:center; margin-top:2rem;">
                    <button id="spotify-login-btn-home" class="btn btn-info" style="margin-bottom:1rem;">
                        <img src="https://developer.spotify.com/assets/branding-guidelines/icon3@2x.png" alt="Spotify" style="height:20px;vertical-align:middle;margin-right:8px;">
                        Login with Spotify
                    </button>
                    <div id="spotify-player-home" style="margin-top:1rem; display:none;">
                        <div id="spotify-player-ui-home" style="display:none;">
                            <div id="spotify-track-info-home"></div>
                            <button class="btn btn-primary" id="spotify-prev-btn-home">‚èÆÔ∏è</button>
                            <button class="btn btn-primary" id="spotify-play-btn-home">‚ñ∂Ô∏è</button>
                            <button class="btn btn-primary" id="spotify-pause-btn-home">‚è∏Ô∏è</button>
                            <button class="btn btn-primary" id="spotify-next-btn-home">‚è≠Ô∏è</button>
                        </div>
                        <button class="btn btn-primary" onclick="playSpotifyTrack()">‚ñ∂Ô∏è Play Music</button>
                        <div id="spotify-premium-warning-home" class="warning" style="display:none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Home Screen -->
        <div id="home-screen" class="screen">
            <div class="card">
                <h2 id="game-title">Welcome to The Game!</h2>
                <p id="game-description">Game description</p>
                
                <div class="input-group">
                    <label>Your Name:</label>
                    <input type="text" id="player-name" placeholder="Enter your name" maxlength="20">
                </div>

                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="createRoom()">üéÆ Create Room</button>
                    <button class="btn btn-warning" onclick="showJoinRoom()">üö™ Join Room</button>
                    <button class="btn btn-secondary" onclick="backToGameSelection()">‚Üê Back to Game Selection</button>
                </div>

                <!-- Spotify Integration -->
                <div style="text-align:center; margin-top:2rem;">
                    <button id="spotify-login-btn" class="btn btn-info" style="margin-bottom:1rem;">
                        <img src="https://developer.spotify.com/assets/branding-guidelines/icon3@2x.png" alt="Spotify" style="height:20px;vertical-align:middle;margin-right:8px;">
                        Login with Spotify
                    </button>
                    <div id="spotify-player" style="margin-top:1rem; display:none;">
                        <div id="spotify-player-ui" style="display:none;">
                            <div id="spotify-track-info"></div>
                            <button class="btn btn-primary" id="spotify-prev-btn">‚èÆÔ∏è</button>
                            <button class="btn btn-primary" id="spotify-play-btn">‚ñ∂Ô∏è</button>
                            <button class="btn btn-primary" id="spotify-pause-btn">‚è∏Ô∏è</button>
                            <button class="btn btn-primary" id="spotify-next-btn">‚è≠Ô∏è</button>
                        </div>
                        <button class="btn btn-primary" onclick="playSpotifyTrack()">‚ñ∂Ô∏è Play Music</button>
                        <div id="spotify-premium-warning" class="warning" style="display:none;"></div>
                    </div>
                </div>

                <div id="join-room-section" style="display: none; margin-top: 1rem;">
                    <div class="input-group">
                        <label>Room Code:</label>
                        <input type="text" id="room-code" placeholder="Enter room code" maxlength="6">
                    </div>
                    <button class="btn btn-primary" onclick="joinRoom()">Join</button>

                    <!-- Public Lobbies Browser -->
                    <div id="public-lobbies-section" style="margin-top: 2rem;">
                        <h3>üåê Public Lobbies</h3>
                        <div id="public-lobbies-list"></div>
                    </div>
                </div>
            </div>

            <div class="card" id="locations-card">
                <h3 id="items-title">üìç Possible Locations:</h3>
                <div class="locations-grid" id="locations-list"></div>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="screen">
            <div class="card">
                <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                    <h2>Room: <span id="room-display"></span></h2>
                    <div id="room-type-display" class="room-type-status">
                        <!-- Room type will be displayed here -->
                    </div>
                </div>
                <div id="lobby-players" class="players-list"></div>
                
                <!-- Bot Controls Section (only for The Mole) -->
                <div id="bot-controls" class="bot-controls" style="display: none;">
                    <h3>ü§ñ Bot Management</h3>
                    <div class="bot-status">
                        <span>Bots in room: <strong id="bot-count">0</strong></span>
                        <div>
                            <button id="add-bot-btn" class="btn btn-bot" onclick="addBot()">ü§ñ Add Bot</button>
                            <button id="remove-all-bots-btn" class="btn btn-secondary" onclick="removeAllBots()" style="display: none;">Remove All Bots</button>
                        </div>
                    </div>
                    <div id="bot-warning" class="bot-warning" style="display: none;">
                        ‚ö†Ô∏è Bots will be automatically removed if you set custom locations
                    </div>
                </div>

                <!-- NEW: Room Type Controls (host only) -->
                <div id="room-type-controls" class="room-type-controls" style="display: none;">
                    <h3>üîí Room Settings</h3>
                    <div class="room-type-options">
                        <button class="btn btn-primary room-type-btn" onclick="changeRoomType('public')" data-type="public">
                            üåê Public
                        </button>
                        <button class="btn btn-warning room-type-btn" onclick="changeRoomType('private')" data-type="private">
                            üîí Private
                        </button>
                        <button class="btn btn-danger room-type-btn" onclick="changeRoomType('locked')" data-type="locked">
                            üö´ Locked
                        </button>
                    </div>
                    <p class="room-type-description" id="room-type-description">
                        Public rooms are visible in the lobby browser and joinable by code.
                    </p>
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button id="ready-btn" class="btn btn-warning" onclick="toggleReady()">Ready Up</button>
                    <button id="start-btn" class="btn btn-primary" onclick="startGame()" style="display: none;">üéÆ Start Game</button>
                    <button id="custom-locations-btn" class="btn btn-info" onclick="showCustomLocations()" style="display: none;">üéØ Custom Locations</button>
                    <button class="btn btn-info" onclick="showScoreboard()">üìä Scoreboard</button>
                    <button class="btn btn-secondary" onclick="backToGameSelection()">‚Üê Back to Game Selection</button>
                </div>
            </div>

            <div class="scoreboard">
                <h3>üèÜ Room Scoreboard</h3>
                <div id="lobby-scoreboard-content">
                    <p>No games played yet. Start your first game!</p>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="game-info">
                <div class="info-card">
                    <h3>Game Status</h3>
                    <p>Round: <span id="current-round">1</span></p>
                    <p id="questions-display">Questions: <span id="questions-count">0/5</span></p>
                    <p id="hints-display" style="display: none;">Hints: <span id="hints-count">0/5</span></p>
                    <p>Turn: <span id="current-turn">-</span></p>
                </div>
                
                <div class="info-card">
                    <h3>Players</h3>
                    <div id="game-players" class="players-list"></div>
                </div>

                <div class="info-card" id="game-locations-card">
                    <h3 id="game-items-title">üìç Possible Locations</h3>
                    <div id="game-locations-list" class="locations-grid"></div>
                </div>
            </div>

            <div id="role-display" class="role-display"></div>

            <!-- Question Section (The Mole only) -->
            <div class="question-section" id="question-section">
                <h3>‚ùì Current Question</h3>
                <div id="current-question" style="margin: 1rem 0; font-style: italic;">Waiting for question...</div>
                
                <div id="ask-section" style="display: none;">
                    <div class="input-group">
                        <label>Ask:</label>
                        <select id="target-select">
                            <option value="">Select player to ask</option>
                        </select>
                    </div>
                    <button id="ask-question-btn" class="btn btn-primary" onclick="askQuestion()">üé≤ Ask Question</button>
                    <div id="question-status" style="margin-top: 0.5rem; font-style: italic; color: rgba(255,255,255,0.7); display: none;">
                        <!-- Status messages will appear here -->
                    </div>
                </div>

                <div id="imposter-reveal-section" style="display: none;">
                    <button class="btn btn-danger" onclick="showImposterReveal()">üé≠ Reveal as Imposter</button>
                </div>
            </div>

            <!-- Hint Section (NBA/Rapper Imposter only) -->
            <div class="hint-section" id="hint-section" style="display: none;">
                <h3 id="hint-title">üí° Give a Hint</h3>
                <div id="current-hint-display" style="margin: 1rem 0; font-style: italic;">Waiting for hints...</div>
                
                <div id="give-hint-section" style="display: none;">
                    <div class="input-group">
                        <label id="hint-label">Your Hint:</label>
                        <textarea id="hint-input" rows="3" placeholder="Give a hint about your player..."></textarea>
                    </div>
                    <button id="give-hint-btn" class="btn btn-primary" onclick="giveHint()">üí° Give Hint</button>
                </div>

                <div id="imposter-guess-section" style="display: none;">
                    <button class="btn btn-danger" onclick="showImposterGuess()">üé≠ Guess as Imposter</button>
                </div>
            </div>

            <div id="ready-to-vote-section" class="ready-to-vote-section" style="display: none;">
                <p>üó≥Ô∏è Ready to start voting?</p>
                <div class="ready-count" id="ready-count-display">0 players ready</div>
                <p>At least <span id="required-count">2</span> players need to be ready before voting begins.</p>
                <button id="ready-to-vote-btn" class="btn btn-warning" onclick="readyToVote()">I'm Ready to Vote!</button>
            </div>

            <div id="voting-section" class="voting-section" style="display: none;">
                <h3>üó≥Ô∏è Vote for the Imposter</h3>
                <p>Choose who you think is the imposter:</p>
                <div id="vote-options"></div>
            </div>

            <div class="scoreboard">
                <h3>üìä Current Scores</h3>
                <div id="game-scoreboard-content"></div>
                <button class="btn btn-info" onclick="showScoreboard()">View Full Scoreboard</button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="screen">
            <div class="card">
                <h2>üèÅ Game Over!</h2>
                <div id="game-result"></div>
                <div id="game-summary"></div>
                <button class="btn btn-primary" onclick="backToLobby()">Back to Lobby</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="answer-modal" class="modal">
        <div class="modal-content">
            <h3>Answer the Question</h3>
            <div id="modal-question"></div>
            <div class="input-group">
                <label>Your Answer:</label>
                <textarea id="answer-input" rows="4" placeholder="Type your answer here..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="submitAnswer()">Submit Answer</button>
        </div>
    </div>

    <!-- NEW: Hint turn modal -->
    <div id="hint-turn-modal" class="modal">
        <div class="modal-content">
            <h3>Your Turn!</h3>
            <p>It's your turn to give a hint about your player.</p>
            <div class="input-group">
                <label>Your Hint:</label>
                <textarea id="hint-turn-input" rows="4" placeholder="Give a hint about your player..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="submitHintFromModal()">Submit Hint</button>
            <button class="btn btn-secondary" onclick="hideModal('hint-turn-modal')">‚úï Close</button>
        </div>
    </div>

    <!-- UPDATED: Imposter modal with text input instead of dropdown -->
    <div id="imposter-modal" class="modal">
        <div class="modal-content">
            <h3>üé≠ Imposter Reveal!</h3>
            <p id="imposter-modal-text">You're revealing as the imposter. What location do you think it is?</p>
            <div class="input-group">
                <label id="imposter-guess-label">Location Guess:</label>
                <div class="imposter-guess-hint" id="imposter-guess-hint">Start typing to see suggestions...</div>
                <div class="autocomplete-container">
                    <input type="text" id="location-guess-input" placeholder="Type your guess here..." autocomplete="off">
                    <div class="autocomplete-suggestions" id="autocomplete-suggestions"></div>
                </div>
            </div>
            <button class="btn btn-danger" onclick="submitImposterReveal()">Submit Guess</button>
            <button class="btn btn-secondary" onclick="hideModal('imposter-modal')">‚úï Cancel</button>
        </div>
    </div>

    <div id="scoreboard-modal" class="modal">
        <div class="modal-content large">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>üèÜ Detailed Scoreboard</h3>
                <button class="btn btn-warning" onclick="hideScoreboard()" style="margin-left: auto;">‚úï Close</button>
            </div>
            
            <div class="scoreboard-tabs">
                <button class="tab-btn active" onclick="switchTab('current')">Current Scores</button>
                <button class="tab-btn" onclick="switchTab('history')">Game History</button>
                <button class="tab-btn" onclick="switchTab('stats')">Detailed Stats</button>
            </div>

            <div id="current-tab" class="tab-content active">
                <div id="detailed-scoreboard"></div>
            </div>

            <div id="history-tab" class="tab-content">
                <div id="game-history-content"></div>
            </div>

            <div id="stats-tab" class="tab-content">
                <div id="detailed-stats-content"></div>
            </div>
        </div>
    </div>

    <div id="custom-locations-modal" class="modal">
        <div class="modal-content">
            <h3>üéØ Custom Locations</h3>
            <p>Enter your custom locations separated by commas. Leave empty to use default locations.</p>
            <div class="bot-warning">
                ‚ö†Ô∏è Setting custom locations will remove all bots from the room
            </div>
            <div class="input-group">
                <label>Custom Locations:</label>
                <textarea id="custom-locations-input" rows="6" placeholder="Space Station, Underwater Lab, Haunted House, Secret Base, etc."></textarea>
            </div>
            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="setCustomLocations()">Set Custom Locations</button>
                <button class="btn btn-warning" onclick="hideCustomLocations()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="round-summary-modal" class="modal">
        <div class="modal-content">
            <h3>üìä Round Summary</h3>
            <div id="round-summary-content"></div>
            <button class="btn btn-primary" onclick="hideRoundSummary()">Continue</button>
        </div>
    </div>

    <!-- NEW: Leave game confirmation modal -->
    <div id="leave-game-modal" class="modal">
        <div class="modal-content">
            <h3>üö™ Leave Game</h3>
            <p>Are you sure you want to leave the game? You won't be able to rejoin.</p>
            <div style="text-align: center; margin-top: 1rem;">
                <button class="btn btn-danger" onclick="confirmLeaveGame()">Leave</button>
                <button class="btn btn-secondary" onclick="hideModal('leave-game-modal')">Return</button>
            </div>
        </div>
    </div>

    <!-- Add Spotify Music Browser Modal -->
    <div id="spotify-browser-modal" class="modal">
        <div class="modal-content large">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>üéµ Spotify Music Browser</h3>
                <button class="btn btn-warning" onclick="hideSpotifyBrowser()">‚úï Close</button>
            </div>
            <div class="scoreboard-tabs">
                <button class="tab-btn active" id="spotify-tab-playlists" onclick="switchSpotifyTab('playlists')">My Playlists</button>
                <button class="tab-btn" id="spotify-tab-search" onclick="switchSpotifyTab('search')">Search</button>
            </div>
            <div id="spotify-playlists-tab" class="tab-content active">
                <div id="spotify-playlists-list">Loading playlists...</div>
                <div id="spotify-playlist-tracks" style="margin-top:1rem;"></div>
            </div>
            <div id="spotify-search-tab" class="tab-content">
                <div style="margin-bottom:1rem;">
                    <input type="text" id="spotify-search-input" placeholder="Search songs, artists, albums..." style="width:70%;padding:8px;border-radius:6px;">
                    <button class="btn btn-primary" onclick="searchSpotify()">Search</button>
                </div>
                <div id="spotify-search-results"></div>
            </div>
        </div>
    </div>

    <button id="spotify-browse-btn" class="btn btn-info" style="display:none;margin-top:0.5rem;">üéµ Browse Spotify</button>

    <script>
        const socket = io();
        let gameState = {};
        let currentRoom = '';
        let isHost = false;
        let playerName = '';
        let actualPlayerName = '';
        let isReady = false;
        let scoreboardData = [];
        let gameHistory = [];
        let roundEndScoreboard = null;
        let hasClickedReadyToVote = false;
        let customLocations = [];
        let isRoomLocked = false;
        let botCount = 0;
        let usingCustomLocations = false;
        let currentGameType = ''; // NEW: Track current game type
        let currentRoomType = 'public'; // NEW: Track current room type
        let publicLobbies = []; // NEW: Store public lobbies data

        // NEW: Autocomplete variables
        let currentSuggestions = [];
        let selectedSuggestionIndex = -1;

        const locations = [
            "Circus", "Amusement Park", "Crashing Airplane", "Titanic",
            "Burning Orphanage", "Dingy Motel Drug Deal", "Prison", "Safari",
            "Zombie Apocalypse", "Organ-Harvesting Hospital", "Nuclear Submarine",
            "Daycare", "Amazon Rainforest", "Concert Hall", "Space Station",
            "High School", "Haunted Mansion", "Beach"
        ];

        // NEW: Player lists for new games
        const nbaPlayers = ["Lebron James", "Kawhi Leonard", "Steph Curry", "Klay Thompson", "Damian Lillard", "Giannis Antetokounmpo", 
            "Chris Paul", "Zion Williamson", "Ja Morant", "Scottie Barnes", "Chet Holmgren", "Paolo Banchero", 
            "Franz Wagner", "Gradey Dick", "Kyle Lowry", "DeMar DeRozan", "CJ McCollum", "Anthony Davis", 
            "Fred VanVleet", "Miles Bridges", "James Harden", "Russell Westbrook", "Joel Embiid", "Tyrese Maxey", 
            "Mikal Bridges", "Jalen Brunson", "Julius Randle", "OG Anunoby", "Mitchell Robinson", "Kelly Oubre Jr.", 
            "Donte DiVincenzo", "Josh Hart", "Immanuel Quickley", "RJ Barrett", "Jakob Poeltl", "Cam Thomas", 
            "Ben Simmons", "Nic Claxton", "Spencer Dinwiddie", "Jayson Tatum", "Jaylen Brown", "Derrick White", 
            "Jrue Holiday", "Kristaps Porzingis", "Al Horford", "Gary Trent Jr.", "Brook Lopez", "Khris Middleton", 
            "Bobby Portis", "Tyrese Haliburton", "Pascal Siakam", "Myles Turner", "Bennedict Mathurin", "Obi Toppin", 
            "Darius Garland", "Donovan Mitchell", "Evan Mobley", "Jarrett Allen", "DeMar DeRozan", "Zach LaVine", 
            "Nikola Vucevic", "Josh Giddey", "Cade Cunningham", "Jaden Ivey", "Ausar Thompson", "Jalen Duren", 
            "Tobias Harris", "Jimmy Butler", "Bam Adebayo", "Terry Rozier", "Tyler Herro", "Duncan Robinson", 
            "Trae Young", "Clint Capela", "Zaccharie Risacher", "LaMelo Ball", "Miles Bridges", "Brandon Miller", 
            "Grant Williams", "Seth Curry", "Kyle Kuzma", "Jordan Poole", "Alex Sarr", "Shai Gilgeous-Alexander", 
            "Jalen Williams", "Lu Dort", "Alex Caruso", "Nikola Jokic", "Jamal Murray", "Michael Porter Jr.", 
            "Aaron Gordon", "Bruce Brown", "Anthony Edwards", "Mike Conley", "Rudy Gobert", "Karl-Anthony Towns", 
            "Jaden McDaniels", "Naz Reid", "Norman Powell", "Luka Doncic", "Kyrie Irving", "Daniel Gafford", 
            "Kevin Durant", "Devin Booker", "Bradley Beal", "Jusuf Nurkic", "Brandon Ingram", "Dejounte Murray", 
            "Herbert Jones", "D'Angelo Russell", "Austin Reaves", "De'Aaron Fox", "Domantas Sabonis", 
            "Malik Monk", "Buddy Hield", "Andrew Wiggins", "Draymond Green", "Jonathan Kuminga", 
            "Alperen Sengun", "Jalen Green", "Amen Thompson", "Dillon Brooks", "Collin Sexton", "Isaiah Stewart", 
            "Lauri Markkanen", "Walker Kessler", "Jordan Clarkson", "Jaren Jackson Jr.", "Desmond Bane", 
            "Marcus Smart", "Zach Edey", "Victor Wembanyama", "Keldon Johnson", "Devin Vassell", "Jeremy Sochan", 
            "Anfernee Simons", "Scoot Henderson", "Deandre Ayton", "Jerami Grant", "Shaedon Sharpe", 
            "Deni Avdija", "Cooper Flagg"];

        const rappers = ["Drake", "Future", "21 Savage", "Travis Scott", "Kanye", "XXXTentacion", "Nav", "Roddy Ricch", "A Boogie wit da Hoodie", 
            "Post Malone", "Lil Baby", "Lil Wayne", "Baby Keem", "Kendrick Lamar", "Lil Tecca", "Don Toliver", "Chris Brown", 
            "Coi Leray", "Nicki Minaj", "Cardi B", "DaBaby", "J. Cole", "Eminem", "Gunna", "Quavo", "Jay-Z", "Juice WRLD", "Big Black Banana Man", 
            "The Weeknd", "Kid Cudi", "Kodak Black", "Lil Durk", "Lil Skies", "Lil Tjay", "Lil Uzi Vert", "Meek Mill", "Nas", "PARTYNEXTDOOR",
            "Offset", "PARTYNEXTDOOR", "Playboi Carti", "Polo G", "Pop Smoke", "Swae Lee", "Tory Lanez", "Young Thug", "Ty Dolla $ign", "Nicki Minaj"];

        // NEW: Game selection function
        function selectGame(gameType) {
            const globalName = document.getElementById('global-player-name').value.trim();
            if (!globalName) {
                showError('Please enter your name first');
                return;
            }

            currentGameType = gameType;
            document.getElementById('player-name').value = globalName;
            
            // Update UI based on game type
            if (gameType === 'mole') {
                document.getElementById('game-title').textContent = 'üïµÔ∏è The Mole';
                document.getElementById('game-description').textContent = 'Find the imposter among your friends in this exciting deduction game.';
                document.getElementById('items-title').textContent = 'üìç Possible Locations:';
                populateLocationsList(locations);
            } else if (gameType === 'nba') {
                document.getElementById('game-title').textContent = 'üèÄ NBA Imposter';
                document.getElementById('game-description').textContent = 'Give hints about NBA players and find the imposter!';
                document.getElementById('items-title').textContent = 'üèÄ NBA Players:';
                populateLocationsList(nbaPlayers);
            } else if (gameType === 'rapper') {
                document.getElementById('game-title').textContent = 'üé§ Rapper Imposter';
                document.getElementById('game-description').textContent = 'Give hints about rappers and find the imposter!';
                document.getElementById('items-title').textContent = 'üé§ Rappers:';
                populateLocationsList(rappers);
            }

            showScreen('home-screen');
        }

        function backToGameSelection() {
            currentGameType = '';
            currentRoom = '';
            isHost = false;
            playerName = '';
            actualPlayerName = '';
            isReady = false;
            hasClickedReadyToVote = false;
            
            // Reset global name from current name
            const currentName = document.getElementById('player-name').value;
            if (currentName) {
                document.getElementById('global-player-name').value = currentName;
            }
            
            showScreen('game-selection-screen');
        }

        function populateLocationsList(items) {
            const locationsList = document.getElementById('locations-list');
            locationsList.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'location-item';
                div.textContent = item;
                locationsList.appendChild(div);
            });
        }

        // NEW: Autocomplete functionality for imposter guess
        function initializeAutocomplete() {
            const input = document.getElementById('location-guess-input');
            const suggestionsContainer = document.getElementById('autocomplete-suggestions');
            
            input.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                
                if (query.length === 0) {
                    hideSuggestions();
                    return;
                }
                
                let itemsToSearch = locations;
                if (currentGameType === 'nba') {
                    itemsToSearch = nbaPlayers;
                } else if (currentGameType === 'rapper') {
                    itemsToSearch = rappers;
                } else if (customLocations.length > 0) {
                    itemsToSearch = customLocations;
                }
                
                const matches = itemsToSearch.filter(item => 
                    item.toLowerCase().includes(query)
                ).slice(0, 10); // Limit to 10 suggestions
                
                showSuggestions(matches);
            });
            
            input.addEventListener('keydown', function(e) {
                const suggestionsContainer = document.getElementById('autocomplete-suggestions');
                const suggestions = suggestionsContainer.querySelectorAll('.autocomplete-suggestion');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
                    updateSelectedSuggestion();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                    updateSelectedSuggestion();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedSuggestionIndex >= 0 && suggestions[selectedSuggestionIndex]) {
                        selectSuggestion(suggestions[selectedSuggestionIndex].textContent);
                    } else {
                        submitImposterReveal();
                    }
                } else if (e.key === 'Escape') {
                    hideSuggestions();
                }
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    hideSuggestions();
                }
            });
        }
        
        function showSuggestions(matches) {
            const suggestionsContainer = document.getElementById('autocomplete-suggestions');
            currentSuggestions = matches;
            selectedSuggestionIndex = -1;
            
            if (matches.length === 0) {
                hideSuggestions();
                return;
            }
            
            suggestionsContainer.innerHTML = '';
            matches.forEach((match, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-suggestion';
                div.textContent = match;
                div.addEventListener('click', () => selectSuggestion(match));
                suggestionsContainer.appendChild(div);
            });
            
            suggestionsContainer.style.display = 'block';
        }
        
        function hideSuggestions() {
            const suggestionsContainer = document.getElementById('autocomplete-suggestions');
            suggestionsContainer.style.display = 'none';
            selectedSuggestionIndex = -1;
        }
        
        function updateSelectedSuggestion() {
            const suggestions = document.querySelectorAll('.autocomplete-suggestion');
            suggestions.forEach((suggestion, index) => {
                suggestion.classList.toggle('selected', index === selectedSuggestionIndex);
            });
        }
        
        function selectSuggestion(value) {
            const input = document.getElementById('location-guess-input');
            input.value = value;
            hideSuggestions();
            input.focus();
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateLocationsList(locations); // Default to locations
            initializeAutocomplete();
        });

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function createRoom() {
            playerName = document.getElementById('player-name').value.trim();
            if (!playerName) {
                showError('Please enter your name');
                return;
            }
            socket.emit('create_room', { playerName, gameType: currentGameType });
        }

        function showJoinRoom() {
            document.getElementById('join-room-section').style.display = 'block';
            socket.emit('get_public_lobbies', { gameType: currentGameType });
        }

        function joinPublicLobby(roomCode) {
            const playerName = document.getElementById('player-name').value.trim();
            if (!playerName) {
                showError('Please enter your name first');
                return;
            }
            
            document.getElementById('room-code').value = roomCode;
            joinRoom();
        }

        function joinRoom() {
            playerName = document.getElementById('player-name').value.trim();
            const roomCode = document.getElementById('room-code').value.trim().toUpperCase();
            
            if (!playerName || !roomCode) {
                showError('Please enter your name and room code');
                return;
            }
            
            socket.emit('join_room', { roomCode, playerName, gameType: currentGameType });
        }

        function toggleReady() {
            socket.emit('toggle_ready');
        }

        function kickPlayer(targetId) {
            if (!isHost) return;
            
            if (confirm('Are you sure you want to kick this player?')) {
                socket.emit('kick_player', { targetId });
            }
        }

        // Bot management functions (only for The Mole)
        function addBot() {
            if (!isHost) {
                showError('Only the host can add bots');
                return;
            }
            
            const totalPlayers = document.querySelectorAll('.player-card').length;
            
            if (totalPlayers >= 8) {
                showError('Room is full (8/8 players)');
                return;
            }
            
            if (usingCustomLocations) {
                showError('Cannot add bots when using custom locations');
                return;
            }
            
            socket.emit('add_bot', { difficulty: 'medium' });
        }

        function removeBot(botId) {
            if (!isHost) return;
            
            if (confirm('Are you sure you want to remove this bot?')) {
                socket.emit('remove_bot', { botId });
            }
        }

        function removeAllBots() {
            if (!isHost) return;
            
            if (confirm('Are you sure you want to remove all bots?')) {
                const players = document.querySelectorAll('.player-card.bot');
                players.forEach(playerCard => {
                    const kickBtn = playerCard.querySelector('.kick-btn');
                    if (kickBtn) {
                        kickBtn.click();
                    }
                });
            }
        }

        function updateBotControls() {
            const botControls = document.getElementById('bot-controls');
            
            // Only show bot controls for The Mole game
            if (currentGameType !== 'mole' || !isHost) {
                botControls.style.display = 'none';
                return;
            }
            
            const botCountSpan = document.getElementById('bot-count');
            const addBotBtn = document.getElementById('add-bot-btn');
            const removeAllBotsBtn = document.getElementById('remove-all-bots-btn');
            const botWarning = document.getElementById('bot-warning');
            
            botControls.style.display = 'block';
            botCountSpan.textContent = botCount;
            
            const totalPlayers = document.querySelectorAll('.player-card').length;
            
            const canAddBot = totalPlayers < 8 && !usingCustomLocations;
            addBotBtn.style.display = 'inline-block';
            addBotBtn.disabled = !canAddBot;
            
            if (totalPlayers >= 8) {
                addBotBtn.textContent = 'ü§ñ Room Full (8/8)';
            } else if (usingCustomLocations) {
                addBotBtn.textContent = 'ü§ñ Disabled (Custom Locations)';
            } else {
                addBotBtn.textContent = `ü§ñ Add Bot (${totalPlayers}/8)`;
            }
            
            removeAllBotsBtn.style.display = botCount > 0 ? 'inline-block' : 'none';
            botWarning.style.display = usingCustomLocations ? 'block' : 'none';
        }

        function startGame() {
            if (!isHost) return;
            
            if (customLocations.length > 0) {
                socket.emit('start_game', { customLocations, gameType: currentGameType });
            } else {
                socket.emit('start_game', { gameType: currentGameType });
            }
        }

        // NEW: Hint functions for NBA/Rapper games
        function giveHint() {
            const hint = document.getElementById('hint-input').value.trim();
            if (!hint) {
                showError('Please provide a hint');
                return;
            }

            socket.emit('give_hint', { hint });
            document.getElementById('hint-input').value = '';
            document.getElementById('give-hint-section').style.display = 'none';
        }

        function submitHintFromModal() {
            const hint = document.getElementById('hint-turn-input').value.trim();
            if (!hint) {
                showError('Please provide a hint');
                return;
            }

            socket.emit('give_hint', { hint });
            document.getElementById('hint-turn-input').value = '';
            hideModal('hint-turn-modal');
        }

        function showImposterGuess() {
            // Update modal text based on game type
            const modalText = document.getElementById('imposter-modal-text');
            const guessLabel = document.getElementById('imposter-guess-label');
            const guessHint = document.getElementById('imposter-guess-hint');
            const input = document.getElementById('location-guess-input');
            
            if (currentGameType === 'nba') {
                modalText.textContent = "You're revealing as the imposter. Which NBA player do you think it is?";
                guessLabel.textContent = 'NBA Player Guess:';
                guessHint.textContent = 'Start typing an NBA player name...';
                input.placeholder = 'Type NBA player name...';
            } else if (currentGameType === 'rapper') {
                modalText.textContent = "You're revealing as the imposter. Which rapper do you think it is?";
                guessLabel.textContent = 'Rapper Guess:';
                guessHint.textContent = 'Start typing a rapper name...';
                input.placeholder = 'Type rapper name...';
            } else {
                modalText.textContent = "You're revealing as the imposter. What location do you think it is?";
                guessLabel.textContent = 'Location Guess:';
                guessHint.textContent = 'Start typing a location...';
                input.placeholder = 'Type location name...';
            }
            
            // Clear the input
            input.value = '';
            hideSuggestions();
            
            showModal('imposter-modal');
            
            // Focus the input after modal is shown
            setTimeout(() => {
                input.focus();
            }, 100);
        }

        // The Mole functions (unchanged)
        function askQuestion() {
            const targetId = document.getElementById('target-select').value;
            if (!targetId) {
                showError('Please select a player to ask');
                return;
            }

            updateQuestionStatus('asking', 'Sending question...');
            socket.emit('ask_question', { targetId });
        }

        function submitAnswer() {
            const answer = document.getElementById('answer-input').value.trim();
            if (!answer) {
                showError('Please provide an answer');
                return;
            }

            const { asker, target, question } = gameState.currentQuestion;
            socket.emit('submit_answer', { asker, target, question, answer });
            
            document.getElementById('answer-input').value = '';
            hideModal('answer-modal');
        }

        function readyToVote() {
            if (hasClickedReadyToVote) {
                showError('You have already indicated you are ready to vote');
                return;
            }
            
            socket.emit('ready_to_vote');
            hasClickedReadyToVote = true;
            
            const btn = document.getElementById('ready-to-vote-btn');
            btn.textContent = 'Ready! Waiting for others...';
            btn.disabled = true;
            btn.className = 'btn btn-primary';
        }

        function submitVote(targetId) {
            console.log('Submitting vote for:', targetId);
            socket.emit('submit_vote', { targetId });
            document.getElementById('voting-section').style.display = 'none';
        }

        function showImposterReveal() {
            showImposterGuess(); // Use the same modal
        }

        function submitImposterReveal() {
            const locationGuess = document.getElementById('location-guess-input').value.trim();
            if (!locationGuess) {
                const itemType = currentGameType === 'nba' ? 'player' : 
                                currentGameType === 'rapper' ? 'rapper' : 'location';
                showError(`Please enter a ${itemType}`);
                return;
            }
            
            if (currentGameType === 'mole') {
                socket.emit('imposter_reveal', { locationGuess });
            } else {
                socket.emit('imposter_guess', { guess: locationGuess });
            }
            hideModal('imposter-modal');
        }

        function updateGameLocations() {
            const gameLocationsList = document.getElementById('game-locations-list');
            const gameItemsTitle = document.getElementById('game-items-title');
            
            gameLocationsList.innerHTML = '';
            
            let itemsToShow = locations;
            let titleText = 'üìç Possible Locations';
            
            if (currentGameType === 'nba') {
                itemsToShow = nbaPlayers;
                titleText = 'üèÄ NBA Players';
            } else if (currentGameType === 'rapper') {
                itemsToShow = rappers;
                titleText = 'üé§ Rappers';
            } else if (customLocations.length > 0) {
                itemsToShow = customLocations;
            }
            
            gameItemsTitle.textContent = titleText;
            
            itemsToShow.forEach(item => {
                const div = document.createElement('div');
                div.className = 'location-item';
                div.textContent = item;
                gameLocationsList.appendChild(div);
            });
        }

        function backToLobby() {
            showScreen('lobby-screen');
            gameState = {};
            hasClickedReadyToVote = false;
            setTimeout(() => {
                socket.emit('request_scoreboard');
            }, 500);
        }

        function updateQuestionStatus(status, message) {
            const statusElement = document.getElementById('question-status');
            const askBtn = document.getElementById('ask-question-btn');
            
            if (statusElement) {
                statusElement.style.display = 'block';
                statusElement.className = `question-status-${status}`;
                statusElement.textContent = message;
            }
            
            if (askBtn) {
                switch(status) {
                    case 'ready':
                        askBtn.disabled = false;
                        askBtn.textContent = 'üé≤ Ask Question';
                        break;
                    case 'asking':
                        askBtn.disabled = true;
                        askBtn.textContent = 'Asking...';
                        break;
                    case 'waiting':
                        askBtn.disabled = true;
                        askBtn.textContent = 'Waiting for answer...';
                        break;
                    case 'asked':
                        askBtn.disabled = true;
                        askBtn.textContent = 'Question asked this turn';
                        break;
                }
            }
        }

        function showScoreboard() {
            socket.emit('request_scoreboard');
            showModal('scoreboard-modal');
        }

        function hideScoreboard() {
            hideModal('scoreboard-modal');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-btn:nth-child(${tabName === 'current' ? 1 : tabName === 'history' ? 2 : 3})`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function showRoundSummary(summaryData) {
            document.getElementById('round-summary-content').innerHTML = summaryData;
            showModal('round-summary-modal');
        }

        function hideRoundSummary() {
            hideModal('round-summary-modal');
        }

        function showCustomLocations() {
            showModal('custom-locations-modal');
        }

        function hideCustomLocations() {
            hideModal('custom-locations-modal');
        }

        function setCustomLocations() {
            const input = document.getElementById('custom-locations-input').value.trim();
            
            if (input) {
                customLocations = input.split(',')
                    .map(loc => loc.trim())
                    .filter(loc => loc.length > 0);
                
                if (customLocations.length < 3) {
                    showError('Please provide at least 3 custom locations');
                    return;
                }
                
                showSuccess(`Custom locations set: ${customLocations.length} locations`);
            } else {
                customLocations = [];
                showSuccess('Using default locations');
            }
            
            hideCustomLocations();
        }

        function changeRoomType(roomType) {
            if (!isHost) {
                showError('Only the host can change room type');
                return;
            }
            
            socket.emit('change_room_type', { roomType });
        }

        function updateRoomTypeDisplay(roomType) {
            currentRoomType = roomType;
            const roomTypeDisplay = document.getElementById('room-type-display');
            const roomTypeControls = document.getElementById('room-type-controls');
            
            // Update room type display
            roomTypeDisplay.className = `room-type-status ${roomType}`;
            
            const typeTexts = {
                public: 'üåê Public',
                private: 'üîí Private', 
                locked: 'üö´ Locked'
            };
            
            roomTypeDisplay.textContent = typeTexts[roomType];
            
            // Update room type controls (host only)
            if (isHost) {
                roomTypeControls.style.display = 'block';
                
                // Update active button
                document.querySelectorAll('.room-type-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-type="${roomType}"]`).classList.add('active');
                
                // Update description
                const descriptions = {
                    public: 'Public rooms are visible in the lobby browser and joinable by code.',
                    private: 'Private rooms are only joinable by code (not visible in lobby browser).',
                    locked: 'Locked rooms - no new players can join.'
                };
                document.getElementById('room-type-description').textContent = descriptions[roomType];
            } else {
                roomTypeControls.style.display = 'none';
            }
        }

        function displayPublicLobbies(lobbies) {
            console.log('Displaying public lobbies:', lobbies);
            const container = document.getElementById('public-lobbies-list');
            
            if (!lobbies || lobbies.length === 0) {
                container.innerHTML = '<p>No public lobbies available at the moment.</p>';
                return;
            }
            
            let html = '';
            lobbies.forEach(lobby => {
                const gameTypeText = lobby.gameType === 'nba' ? 'NBA Imposter' : 
                                    lobby.gameType === 'rapper' ? 'Rapper Imposter' : 'The Mole';
                
                const timeAgo = getTimeAgo(new Date(lobby.createdAt));
                
                html += `
                    <div class="public-lobby-item" onclick="joinPublicLobby('${lobby.roomCode}')">
                        <div class="public-lobby-header">
                            <span class="public-lobby-code">${lobby.roomCode}</span>
                            <span class="public-lobby-game-type">${gameTypeText}</span>
                        </div>
                        <div class="public-lobby-details">
                            <div class="public-lobby-detail players">
                                üë• ${lobby.playerCount}/${lobby.maxPlayers} players
                            </div>
                            <div class="public-lobby-detail">
                                üëë ${lobby.hostName}
                            </div>
                            ${lobby.botCount > 0 ? `<div class="public-lobby-detail bots">ü§ñ ${lobby.botCount} bots</div>` : ''}
                            ${lobby.usingCustomLocations ? '<div class="public-lobby-detail custom">üéØ Custom locations</div>' : ''}
                            <div class="public-lobby-detail time">
                                ‚è∞ ${timeAgo}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${Math.floor(diffHours / 24)}d ago`;
        }

        // Socket event handlers
        socket.on('room_created', (data) => {
            leftRoom = false;
            currentRoom = data.roomCode;
            isHost = data.isHost;
            actualPlayerName = data.actualName;
            playerName = actualPlayerName;
            currentGameType = data.gameType;
            currentRoomType = data.roomType || 'public';
            document.getElementById('room-display').textContent = currentRoom;
            updateRoomTypeDisplay(currentRoomType);
            showScreen('lobby-screen');
            showSuccess(`Room created! Code: ${currentRoom}`);
        });

        socket.on('room_joined', (data) => {
            leftRoom = false;
            currentRoom = data.roomCode;
            isHost = data.isHost;
            actualPlayerName = data.actualName;
            playerName = actualPlayerName;
            currentGameType = data.gameType;
            currentRoomType = data.roomType || 'public';
            document.getElementById('room-display').textContent = currentRoom;
            updateRoomTypeDisplay(currentRoomType);
            showScreen('lobby-screen');
            showSuccess(`Joined room: ${currentRoom}`);
        });

        socket.on('name_changed', (data) => {
            showWarning(`Your name was changed from "${data.originalName}" to "${data.newName}" because that name was already taken.`);
        });

        socket.on('room_type_changed', (data) => {
            updateRoomTypeDisplay(data.roomType);
            showInfo(data.message);
        });

        socket.on('public_lobbies', (data) => {
            console.log('Received public lobbies:', data);
            publicLobbies = data;
            displayPublicLobbies(data);
        });

        socket.on('kicked', (data) => {
            showError(data.message);
            backToGameSelection();
        });

        // Bot event handlers (The Mole only)
        socket.on('bot_added', (data) => {
            showSuccess(`Bot ${data.botName} added to the room`);
            botCount = data.botCount;
            updateBotControls();
        });

        socket.on('bot_removed', (data) => {
            showInfo(`Bot ${data.botName} removed from the room`);
            botCount = data.botCount;
            updateBotControls();
        });

        socket.on('bots_removed_custom_locations', (data) => {
            showWarning(`${data.removedBots.length} bots removed: ${data.removedBots.join(', ')}`);
            showInfo(data.message);
            botCount = 0;
            updateBotControls();
        });

        socket.on('player_kicked', (data) => {
            if (data.wasBot) {
                showInfo(`Bot ${data.kickedPlayerName} was removed`);
                botCount = data.botCount;
            } else {
                showInfo(`${data.kickedPlayerName} was kicked from the room`);
            }
            
            // Check if current player became host
            const currentPlayer = data.players.find(p => p.name === actualPlayerName);
            if (currentPlayer && currentPlayer.isHost && !isHost) {
                isHost = true;
                showInfo('You are now the host!');
            }
            
            updateLobbyPlayers(data.players);
            if (data.scoreboard) {
                updateLobbyScoreboard(data.scoreboard);
            }
            if (data.hasOwnProperty('roomType')) {
                updateRoomTypeDisplay(data.roomType);
            }
            updateBotControls();
        });

        socket.on('room_updated', (data) => {
            // Check if current player became host
            const currentPlayer = data.players.find(p => p.name === actualPlayerName);
            if (currentPlayer && currentPlayer.isHost && !isHost) {
                isHost = true;
                showInfo('You are now the host!');
            }
            
            updateLobbyPlayers(data.players);
            if (data.scoreboard) {
                updateLobbyScoreboard(data.scoreboard);
            }
            if (data.hasOwnProperty('roomType')) {
                updateRoomTypeDisplay(data.roomType);
            }
            if (data.hasOwnProperty('botCount')) {
                botCount = data.botCount;
            }
            if (data.hasOwnProperty('usingCustomLocations')) {
                usingCustomLocations = data.usingCustomLocations;
            }
            if (data.hasOwnProperty('gameType')) {
                currentGameType = data.gameType;
            }
            updateBotControls();
        });

        socket.on('player_left', (data) => {
            showInfo(`${data.playerName} left the room`);
            
            // Check if current player became host
            const currentPlayer = data.players.find(p => p.name === actualPlayerName);
            if (currentPlayer && currentPlayer.isHost && !isHost) {
                isHost = true;
                showInfo('You are now the host!');
            }
            
            updateLobbyPlayers(data.players);
            if (data.scoreboard) {
                updateLobbyScoreboard(data.scoreboard);
            }
            if (data.hasOwnProperty('roomType')) {
                updateRoomTypeDisplay(data.roomType);
            }
            if (data.hasOwnProperty('botCount')) {
                botCount = data.botCount;
            }
            updateBotControls();
        });

        socket.on('game_started', (data) => {
            gameState = data;
            hasClickedReadyToVote = false;
            currentGameType = data.gameType;
            
            // Clear any persistent UI elements
            document.getElementById('ask-section').style.display = 'none';
            document.getElementById('give-hint-section').style.display = 'none';
            document.getElementById('ready-to-vote-section').style.display = 'none';
            document.getElementById('voting-section').style.display = 'none';
            document.getElementById('imposter-reveal-section').style.display = 'none';
            document.getElementById('imposter-guess-section').style.display = 'none';
            document.getElementById('question-status').style.display = 'none';
            
            if (data.scoreboard) {
                scoreboardData = data.scoreboard;
            }
            showScreen('game-screen');
            updateGameDisplay();
            updateGameLocations();
            
            if (data.isImposter) {
                addToLog('üé≠ You are the IMPOSTER!');
            } else {
                if (currentGameType === 'mole') {
                    addToLog(`üìç Location: ${data.playerRole}`);
                } else {
                    addToLog(`üë§ Your ${currentGameType === 'nba' ? 'NBA Player' : 'Rapper'}: ${data.playerRole}`);
                }
            }
        });

        // NEW: Hint given event for NBA/Rapper games
        socket.on('hint_given', (data) => {
            const hintText = `üí° ${data.player}: "${data.hint}"`;
            document.getElementById('current-hint-display').innerHTML = hintText;
            
            gameState.hintsThisRound = data.hintsThisRound;
            gameState.currentTurn = data.currentTurn;
            updateGameDisplay();
        });

        // NEW: Your turn event for hint games
        socket.on('your_hint_turn', () => {
            showModal('hint-turn-modal');
            document.getElementById('hint-turn-input').focus();
        });

        socket.on('question_asked', (data) => {
            gameState.currentQuestion = data;
            gameState.questionAskedThisTurn = true;
            gameState.waitingForAnswer = true;
            
            document.getElementById('current-question').innerHTML = 
                `<strong>${data.asker}</strong> asks <strong>${data.target}</strong>: "${data.question}"`;
            
            if (data.targetId === socket.id) {
                document.getElementById('modal-question').innerHTML = 
                    `<strong>${data.asker}</strong> asks: "${data.question}"`;
                showModal('answer-modal');
                document.getElementById('answer-input').focus();
            }
        });

        socket.on('answer_submitted', (data) => {
            if (gameState.currentQuestion && gameState.currentQuestion.asker === playerName) {
                gameState.questionAskedThisTurn = false;
                gameState.waitingForAnswer = false;
                updateQuestionStatus('ready', 'Answer received! You can ask another question if it\'s still your turn.');
            }
        });

        socket.on('game_updated', (data) => {
            console.log('Game updated:', data.status, 'Round:', data.currentRound, 'Current turn:', data.currentTurn);
            gameState = { ...gameState, ...data };
            if (data.scoreboard) {
                scoreboardData = data.scoreboard;
            }
            updateGameDisplay();
            
            if (data.status === 'voting') {
                showVotingSection();
            } else if (data.status === 'ended') {
                showGameOver();
            }
        });

        socket.on('vote_submitted', (data) => {
            if (data.votesReceived === data.totalPlayers) {
                roundEndScoreboard = {
                    round: gameState.currentRound,
                    scoreboard: [...scoreboardData]
                };
            }
        });

        socket.on('ready_count_updated', (data) => {
            if (gameState.status === 'playing') {
                gameState.readyToVoteCount = data.readyCount;
                updateGameDisplay();
            }
        });

        socket.on('all_votes_received', () => {
            // This event is no longer needed as we handle round end in game_updated
        });

        socket.on('game_over', (result) => {
            console.log('Game over event received:', result);
            
            // Clear any persistent UI elements
            document.getElementById('ask-section').style.display = 'none';
            document.getElementById('give-hint-section').style.display = 'none';
            document.getElementById('ready-to-vote-section').style.display = 'none';
            document.getElementById('voting-section').style.display = 'none';
            document.getElementById('imposter-reveal-section').style.display = 'none';
            document.getElementById('imposter-guess-section').style.display = 'none';
            document.getElementById('question-status').style.display = 'none';
            
            if (result.winner === 'imposter_left') {
                showError('Imposter left the game! No one wins.');
            }
            
            const YOUR_NAME = "Jace"; // <-- Change this to your player name
            if (playerName === YOUR_NAME) {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = '/download-all-games';
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    console.log(`üì• Game data automatically downloaded for ${YOUR_NAME}`);
                }, 1500);
            }
        });

        socket.on('scoreboard_updated', (data) => {
            scoreboardData = data.scoreboard || [];
            gameHistory = data.gameHistory || [];
            updateDetailedScoreboard();
        });

        socket.on('error', (message) => {
            showError(message);
        });

        // NEW: Handle reconnection events
        socket.on('reconnected', (data) => {
            leftRoom = false;
            currentRoom = data.roomCode;
            isHost = data.isHost;
            actualPlayerName = data.actualName;
            playerName = actualPlayerName;
            currentGameType = data.gameType;
            currentRoomType = data.roomType || 'public';
            
            // Clear disconnection state
            disconnectedFromRoom = null;
            disconnectTime = null;
            
            document.getElementById('room-display').textContent = currentRoom;
            updateRoomTypeDisplay(currentRoomType);
            
            // Remove reconnection button
            const reconnectBtn = document.getElementById('reconnect-btn');
            if (reconnectBtn) {
                reconnectBtn.style.display = 'none';
            }
            
            // Hide join room section
            document.getElementById('join-room-section').style.display = 'none';
            
            showScreen('lobby-screen');
            showSuccess(`Reconnected to room: ${currentRoom}`);
        });

        socket.on('player_reconnected', (data) => {
            showInfo(`${data.playerName} reconnected to the game!`);
            updateLobbyPlayers(data.players);
            if (data.scoreboard) {
                updateLobbyScoreboard(data.scoreboard);
            }
            if (data.hasOwnProperty('roomType')) {
                updateRoomTypeDisplay(data.roomType);
            }
            if (data.hasOwnProperty('botCount')) {
                botCount = data.botCount;
            }
            updateBotControls();
        });

        // NEW: Handle disconnection tracking
        socket.on('player_left', (data) => {
            showInfo(`${data.playerName} left the room`);
            
            // Check if current player became host
            const currentPlayer = data.players.find(p => p.name === actualPlayerName);
            if (currentPlayer && currentPlayer.isHost && !isHost) {
                isHost = true;
                showInfo('You are now the host!');
            }
            
            updateLobbyPlayers(data.players);
            if (data.scoreboard) {
                updateLobbyScoreboard(data.scoreboard);
            }
            if (data.hasOwnProperty('roomType')) {
                updateRoomTypeDisplay(data.roomType);
            }
            if (data.hasOwnProperty('botCount')) {
                botCount = data.botCount;
            }
            updateBotControls();
            
            // Check if we were disconnected and can reconnect
            if (data.disconnectedPlayers && data.disconnectedPlayers.includes(actualPlayerName)) {
                disconnectedFromRoom = {
                    roomCode: currentRoom,
                    playerName: actualPlayerName
                };
                disconnectTime = Date.now();
                showWarning('You were disconnected! You can reconnect within 60 seconds.');
                
                // Set the room code in the join input for easy reconnection
                document.getElementById('room-code').value = currentRoom;
                
                showScreen('home-screen');
                document.getElementById('join-room-section').style.display = 'block';
                checkForReconnection();
            }
        });

        // NEW: Check for reconnection on page load
        document.addEventListener('DOMContentLoaded', () => {
            populateLocationsList(locations); // Default to locations
            initializeAutocomplete();
        });

        function updateLobbyPlayers(players) {
            const container = document.getElementById('lobby-players');
            container.innerHTML = '';
            
            players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-card';
                if (player.isHost) div.classList.add('host');
                if (player.isReady) div.classList.add('ready');
                if (player.isBot) div.classList.add('bot');
                
                let kickButton = '';
                if (isHost && !player.isHost) {
                    kickButton = `<button class="kick-btn" onclick="${player.isBot ? 'removeBot' : 'kickPlayer'}('${player.id}')" title="${player.isBot ? 'Remove bot' : 'Kick player'}">‚úï</button>`;
                }
                
                let statusText = '';
                if (player.isHost) {
                    statusText = 'üëë Host';
                } else if (player.isBot) {
                    statusText = 'ü§ñ Bot';
                } else {
                    statusText = player.isReady ? '‚úÖ Ready' : '‚è≥ Not Ready';
                }
                
                div.innerHTML = `
                    ${kickButton}
                    <div><strong>${player.name}</strong></div>
                    <div>${statusText}</div>
                `;
                container.appendChild(div);
            });

            const readyBtn = document.getElementById('ready-btn');
            const startBtn = document.getElementById('start-btn');
            const customLocationsBtn = document.getElementById('custom-locations-btn');
            
            if (isHost) {
                const humanPlayers = players.filter(p => !p.isBot);
                const allHumansReady = humanPlayers.filter(p => !p.isHost).every(p => p.isReady);
                const hasEnoughPlayers = players.length >= 3;
                
                startBtn.style.display = (allHumansReady && hasEnoughPlayers) ? 'inline-block' : 'none';
                customLocationsBtn.style.display = currentGameType === 'mole' ? 'inline-block' : 'none';
                readyBtn.style.display = 'none'; // Always hide ready button for host
            } else {
                const currentPlayer = players.find(p => p.name === actualPlayerName);
                readyBtn.textContent = currentPlayer?.isReady ? 'Cancel Ready' : 'Ready Up';
                readyBtn.className = `btn ${currentPlayer?.isReady ? 'btn-warning' : 'btn-primary'}`;
                startBtn.style.display = 'none';
                customLocationsBtn.style.display = 'none';
            }
            
            updateBotControls();
        }

        function updateLobbyScoreboard(scoreboard) {
            const container = document.getElementById('lobby-scoreboard-content');
            
            if (!scoreboard || scoreboard.length === 0) {
                container.innerHTML = '<p>No games played yet. Start your first game!</p>';
                return;
            }

            const topPlayers = scoreboard.slice(0, 5);
            let html = '<div class="scoreboard-table">';
            html += '<table style="width: 100%;">';
            html += '<thead><tr><th>Rank</th><th>Player</th><th>Score</th><th>Games Won</th></tr></thead>';
            html += '<tbody>';
            
            topPlayers.forEach((player, index) => {
                const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
                let playerClass = '';
                if (!player.isOnline) playerClass += 'offline ';
                if (player.isBot) playerClass += 'bot ';
                
                html += `
                    <tr>
                        <td><span class="rank ${rankClass}">#${index + 1}</span></td>
                        <td><span class="player-name ${playerClass}">${player.name}${player.isBot ? ' ü§ñ' : ''}</span></td>
                        <td><span class="score">${player.score}</span></td>
                        <td>${player.gamesWon}/${player.gamesPlayed}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function updateGameDisplay() {
            if (!gameState.playerOrder) return;

            document.getElementById('current-round').textContent = gameState.currentRound || 1;
            
            // Update question/hint count display based on game type
            if (currentGameType === 'mole') {
                document.getElementById('questions-display').style.display = 'block';
                document.getElementById('hints-display').style.display = 'none';
                document.getElementById('questions-count').textContent = 
                    `${gameState.questionsThisRound || 0}/${gameState.questionsPerRound || 5}`;
            } else {
                document.getElementById('questions-display').style.display = 'none';
                document.getElementById('hints-display').style.display = 'block';
                document.getElementById('hints-count').textContent = 
                    `${gameState.hintsThisRound || 0}/${gameState.hintsPerRound || gameState.playerOrder.length}`;
            }
            
            const currentPlayerIndex = gameState.currentTurn || 0;
            const currentPlayer = gameState.playerOrder[currentPlayerIndex];
            document.getElementById('current-turn').textContent = currentPlayer?.name || '-';

            const roleDisplay = document.getElementById('role-display');
            if (gameState.isImposter) {
                roleDisplay.className = 'role-display role-imposter';
                if (currentGameType === 'mole') {
                    roleDisplay.innerHTML = 'üé≠ You are the IMPOSTER!<br>Find out the location!';
                } else {
                    const itemType = currentGameType === 'nba' ? 'NBA player' : 'rapper';
                    roleDisplay.innerHTML = `üé≠ You are the IMPOSTER!<br>Find out the ${itemType}!`;
                }
                document.getElementById('imposter-reveal-section').style.display = currentGameType === 'mole' ? 'block' : 'none';
                document.getElementById('imposter-guess-section').style.display = currentGameType !== 'mole' ? 'block' : 'none';
            } else if (gameState.playerRole) {
                roleDisplay.className = 'role-display role-location';
                if (currentGameType === 'mole') {
                    roleDisplay.innerHTML = `üìç Location: <strong>${gameState.playerRole}</strong><br>Find the imposter!`;
                } else {
                    const icon = currentGameType === 'nba' ? 'üèÄ' : 'üé§';
                    const itemType = currentGameType === 'nba' ? 'NBA Player' : 'Rapper';
                    roleDisplay.innerHTML = `${icon} Your ${itemType}: <strong>${gameState.playerRole}</strong><br>Find the imposter!`;
                }
                document.getElementById('imposter-reveal-section').style.display = 'none';
                document.getElementById('imposter-guess-section').style.display = 'none';
            }

            const playersContainer = document.getElementById('game-players');
            playersContainer.innerHTML = '';
            
            gameState.playerOrder?.forEach((player, index) => {
                const div = document.createElement('div');
                div.className = 'player-card';
                if (index === gameState.currentTurn) div.classList.add('current-turn');
                if (player.isBot) div.classList.add('bot');
                
                div.innerHTML = `<strong>${player.name}${player.isBot ? ' ü§ñ' : ''}</strong>`;
                playersContainer.appendChild(div);
            });

            // Show/hide appropriate sections based on game type
            const questionSection = document.getElementById('question-section');
            const hintSection = document.getElementById('hint-section');
            
            if (currentGameType === 'mole') {
                questionSection.style.display = 'block';
                hintSection.style.display = 'none';
                updateMoleGameSection();
            } else {
                questionSection.style.display = 'none';
                hintSection.style.display = 'block';
                updateHintGameSection();
            }

            const readyToVoteSection = document.getElementById('ready-to-vote-section');
            const readyCountDisplay = document.getElementById('ready-count-display');
            const requiredCountSpan = document.getElementById('required-count');
            const readyToVoteBtn = document.getElementById('ready-to-vote-btn');

            const hintsOrQuestions = currentGameType === 'mole' ? 
                gameState.questionsThisRound : gameState.hintsThisRound;
            const hintsOrQuestionsPerRound = currentGameType === 'mole' ? 
                gameState.questionsPerRound : gameState.hintsPerRound;

            if (gameState.status === 'playing' && hintsOrQuestions >= hintsOrQuestionsPerRound) {
                readyToVoteSection.style.display = 'block';
                
                const readyCount = gameState.readyToVoteCount || 0;
                const requiredCount = (gameState.playerOrder?.length || 2) - 1;
                
                readyCountDisplay.textContent = `${readyCount}/${requiredCount} players ready`;
                requiredCountSpan.textContent = requiredCount;
                
                if (hasClickedReadyToVote) {
                    readyToVoteBtn.textContent = 'Ready! Waiting for others...';
                    readyToVoteBtn.disabled = true;
                    readyToVoteBtn.className = 'btn btn-primary';
                } else {
                    readyToVoteBtn.textContent = "I'm Ready to Vote!";
                    readyToVoteBtn.disabled = false;
                    readyToVoteBtn.className = 'btn btn-warning';
                }
            } else {
                readyToVoteSection.style.display = 'none';
            }

            updateGameScoreboard();
        }

        function updateMoleGameSection() {
            const targetSelect = document.getElementById('target-select');
            targetSelect.innerHTML = '<option value="">Select player to ask</option>';
            
            gameState.playerOrder?.forEach(player => {
                if (!player.isYou) {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = `${player.name}${player.isBot ? ' ü§ñ' : ''}`;
                    targetSelect.appendChild(option);
                }
            });

            const askSection = document.getElementById('ask-section');
            const isMyTurn = gameState.playerOrder?.[gameState.currentTurn]?.isYou;
            
            askSection.style.display = (isMyTurn && gameState.status === 'playing') ? 'block' : 'none';

            if (isMyTurn && gameState.status === 'playing') {
                if (gameState.waitingForAnswer) {
                    updateQuestionStatus('waiting', 'Waiting for answer to your question...');
                } else if (gameState.questionAskedThisTurn) {
                    updateQuestionStatus('asked', 'You have already asked a question this turn.');
                } else {
                    updateQuestionStatus('ready', 'Your turn! Select a player and ask a question.');
                }
            } else {
                document.getElementById('question-status').style.display = 'none';
            }
        }

        function updateHintGameSection() {
            const giveHintSection = document.getElementById('give-hint-section');
            const isMyTurn = gameState.playerOrder?.[gameState.currentTurn]?.isYou;
            
            giveHintSection.style.display = (isMyTurn && gameState.status === 'playing') ? 'block' : 'none';
            
            // Update hint title based on game type
            const hintTitle = document.getElementById('hint-title');
            const hintLabel = document.getElementById('hint-label');
            
            if (currentGameType === 'nba') {
                hintTitle.textContent = 'üèÄ Give a Hint about your NBA Player';
                hintLabel.textContent = 'Your hint about this NBA player:';
                document.getElementById('hint-input').placeholder = 'Give a hint about your NBA player...';
            } else if (currentGameType === 'rapper') {
                hintTitle.textContent = 'üé§ Give a Hint about your Rapper';
                hintLabel.textContent = 'Your hint about this rapper:';
                document.getElementById('hint-input').placeholder = 'Give a hint about your rapper...';
            }
        }

        function updateGameScoreboard() {
            const container = document.getElementById('game-scoreboard-content');
            
            if (!scoreboardData || scoreboardData.length === 0) {
                container.innerHTML = '<p>Scoreboard will update after the round...</p>';
                return;
            }

            const topPlayers = scoreboardData.slice(0, 3);
            let html = '';
            
            topPlayers.forEach((player, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
                const onlineStatus = player.isOnline ? '' : ' (offline)';
                const botStatus = player.isBot ? ' ü§ñ' : '';
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(255,255,255,0.05); margin: 0.25rem 0; border-radius: 5px;">
                        <span>${medal} ${player.name}${botStatus}${onlineStatus}</span>
                        <span class="score">${player.score}</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateDetailedScoreboard() {
            const currentTab = document.getElementById('detailed-scoreboard');
            if (scoreboardData.length === 0) {
                currentTab.innerHTML = '<p>No data available yet.</p>';
            } else {
                let html = '<table class="scoreboard-table">';
                html += '<thead><tr><th>Rank</th><th>Player</th><th>Score</th><th>Games</th><th>Win Rate</th><th>Imposter Rate</th></tr></thead>';
                html += '<tbody>';
                
                scoreboardData.forEach((player, index) => {
                    const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
                    let playerClass = '';
                    if (!player.isOnline) playerClass += 'offline ';
                    if (player.isBot) playerClass += 'bot ';
                    
                    const winRate = player.gamesPlayed > 0 ? ((player.gamesWon / player.gamesPlayed) * 100).toFixed(1) : '0';
                    const imposterRate = player.timesImposter > 0 ? ((player.timesImposterWon / player.timesImposter) * 100).toFixed(1) : '0';
                    
                    html += `
                        <tr>
                            <td><span class="rank ${rankClass}">#${index + 1}</span></td>
                            <td><span class="player-name ${playerClass}">${player.name}${player.isBot ? ' ü§ñ' : ''}</span></td>
                            <td><span class="score">${player.score}</span></td>
                            <td>${player.gamesWon}/${player.gamesPlayed}</td>
                            <td>${winRate}%</td>
                            <td>${imposterRate}%</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                currentTab.innerHTML = html;
            }

            const historyTab = document.getElementById('game-history-content');
            if (gameHistory.length === 0) {
                historyTab.innerHTML = '<p>No games completed yet.</p>';
            } else {
                let html = '<div class="game-history">';
                gameHistory.slice().reverse().forEach(game => {
                    const gameTypeText = game.gameType === 'nba' ? 'NBA Imposter' : 
                                        game.gameType === 'rapper' ? 'Rapper Imposter' : 'The Mole';
                    const itemText = game.gameType === 'nba' ? 'Player' : 
                                    game.gameType === 'rapper' ? 'Rapper' : 'Location';
                    
                    html += `
                        <div class="history-item">
                            <h4>${gameTypeText} Game #${game.gameNumber} - ${new Date(game.date).toLocaleString()}</h4>
                            <p><strong>${itemText}:</strong> ${game.location}</p>
                            <p><strong>Imposter:</strong> ${game.imposter}</p>
                            <p><strong>Winner:</strong> ${game.winner === 'imposter_wins' ? 'Imposter' : game.gameType === 'mole' ? 'Location Team' : 'Player Team'}</p>
                            <p><strong>Rounds:</strong> ${game.rounds}</p>
                            <details>
                                <summary>Final Scores</summary>
                                ${game.finalScores.map(score => `<p>${score.name}: ${score.score}</p>`).join('')}
                            </details>
                        </div>
                    `;
                });
                html += '</div>';
                historyTab.innerHTML = html;
            }

            const statsTab = document.getElementById('detailed-stats-content');
            if (scoreboardData.length === 0) {
                statsTab.innerHTML = '<p>No stats available yet.</p>';
            } else {
                let html = '<table class="scoreboard-table">';
                html += '<thead><tr><th>Player</th><th>Questions Asked</th><th>Questions Answered</th><th>Vote Accuracy</th><th>Rounds Survived</th></tr></thead>';
                html += '<tbody>';
                
                scoreboardData.forEach(player => {
                    const voteAccuracy = player.totalVotes > 0 ? ((player.correctVotes / player.totalVotes) * 100).toFixed(1) : '0';
                    let playerClass = '';
                    if (!player.isOnline) playerClass += 'offline ';
                    if (player.isBot) playerClass += 'bot ';
                    
                    html += `
                        <tr>
                            <td><span class="player-name ${playerClass}">${player.name}${player.isBot ? ' ü§ñ' : ''}</span></td>
                            <td>${player.questionsAsked || 0}</td>
                            <td>${player.questionsAnswered || 0}</td>
                            <td>${voteAccuracy}% (${player.correctVotes}/${player.totalVotes})</td>
                            <td>${player.roundsSurvived}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                statsTab.innerHTML = html;
            }
        }

        function showVotingSection() {
            const votingSection = document.getElementById('voting-section');
            const voteOptions = document.getElementById('vote-options');
            
            voteOptions.innerHTML = '';
            
            gameState.playerOrder?.forEach(player => {
                if (!player.isYou) {
                    const button = document.createElement('button');
                    button.className = 'btn btn-danger';
                    button.textContent = `${player.name}${player.isBot ? ' ü§ñ' : ''}`;
                    button.onclick = () => submitVote(player.id);
                    voteOptions.appendChild(button);
                }
            });
            
            votingSection.style.display = 'block';
            document.getElementById('ready-to-vote-section').style.display = 'none';
            addToLog('üó≥Ô∏è Voting phase started! Choose who you think is the imposter.');
        }

        function showGameOver() {
            const resultDiv = document.getElementById('game-result');
            const summaryDiv = document.getElementById('game-summary');
            
            if (gameState.gameResult) {
                resultDiv.innerHTML = `
                    <div class="${gameState.gameResult.winner === 'location_wins' || gameState.gameResult.winner === 'player_wins' ? 'success' : 'error'}">
                        <h3>${gameState.gameResult.message}</h3>
                        <p>${currentGameType === 'mole' ? 'Location' : currentGameType === 'nba' ? 'NBA Player' : 'Rapper'}: ${gameState.gameResult.location}</p>
                        <p>Imposter: ${gameState.gameResult.imposter}</p>
                    </div>
                `;
            }

            if (gameState.gameHistory) {
                let summaryHTML = '<h4>Game Summary:</h4>';
                gameState.gameHistory.forEach(entry => {
                    if (currentGameType === 'mole') {
                        summaryHTML += `
                            <div class="log-entry">
                                <strong>${entry.asker}</strong> ‚Üí <strong>${entry.target}</strong>: ${entry.question}<br>
                                <em>${entry.answer}</em>
                            </div>
                        `;
                    } else {
                        summaryHTML += `
                            <div class="log-entry">
                                <strong>${entry.player}</strong>: ${entry.hint}
                            </div>
                        `;
                    }
                });
                summaryDiv.innerHTML = summaryHTML;
            }

            showScreen('game-over-screen');
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.container').firstChild);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.container').insertBefore(successDiv, document.querySelector('.container').firstChild);
            setTimeout(() => successDiv.remove(), 5000);
        }

        function showWarning(message) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'warning';
            warningDiv.textContent = message;
            document.querySelector('.container').insertBefore(warningDiv, document.querySelector('.container').firstChild);
            setTimeout(() => warningDiv.remove(), 5000);
        }

        function showInfo(message) {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'info';
            infoDiv.textContent = message;
            document.querySelector('.container').insertBefore(infoDiv, document.querySelector('.container').firstChild);
            setTimeout(() => infoDiv.remove(), 3000);
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                if (document.getElementById('answer-modal').classList.contains('active')) {
                    submitAnswer();
                } else if (document.getElementById('hint-turn-modal').classList.contains('active')) {
                    submitHintFromModal();
                }
            }
        });

        function attemptReconnection() {
            if (!disconnectedFromRoom || !disconnectTime) {
                showError('No disconnection to reconnect from');
                return;
            }
            
            const timeSinceDisconnect = Date.now() - disconnectTime;
            if (timeSinceDisconnect > 60000) {
                showError('Reconnection window expired (60 seconds)');
                disconnectedFromRoom = null;
                disconnectTime = null;
                return;
            }
            
            // Use join_room instead of separate reconnect event
            socket.emit('join_room', { 
                roomCode: disconnectedFromRoom.roomCode, 
                playerName: disconnectedFromRoom.playerName,
                gameType: currentGameType
            });
        }

        function checkForReconnection() {
            if (disconnectedFromRoom && disconnectTime && !leftRoom) {
                const timeSinceDisconnect = Date.now() - disconnectTime;
                const timeLeft = Math.max(0, 60000 - timeSinceDisconnect);
                
                if (timeLeft > 0) {
                    showWarning(`You were disconnected from room ${disconnectedFromRoom.roomCode}. You can reconnect for ${Math.ceil(timeLeft / 1000)} more seconds.`);
                    
                    // Add reconnection button to home screen
                    const homeScreen = document.getElementById('home-screen');
                    let reconnectBtn = document.getElementById('reconnect-btn');
                    if (!reconnectBtn) {
                        reconnectBtn = document.createElement('button');
                        reconnectBtn.id = 'reconnect-btn';
                        reconnectBtn.className = 'btn btn-warning';
                        reconnectBtn.onclick = attemptReconnection;
                        homeScreen.querySelector('.card').appendChild(reconnectBtn);
                    }
                    reconnectBtn.textContent = `üîÑ Reconnect to ${disconnectedFromRoom.roomCode} (${Math.ceil(timeLeft / 1000)}s)`;
                    reconnectBtn.style.display = 'inline-block';
                    
                    // Show join room section with room code pre-filled
                    document.getElementById('join-room-section').style.display = 'block';
                    document.getElementById('room-code').value = disconnectedFromRoom.roomCode;
                } else {
                    // Reconnection window expired
                    disconnectedFromRoom = null;
                    disconnectTime = null;
                    const reconnectBtn = document.getElementById('reconnect-btn');
                    if (reconnectBtn) {
                        reconnectBtn.style.display = 'none';
                    }
                    showError('Reconnection window expired. You can join a new room.');
                }
            }
        }

        let leftRoom = false; // Track if player left intentionally
        function leaveRoom() {
            leftRoom = true;
            socket.emit('leave_room');
            showScreen('home-screen');
            showInfo('You left the room.');
        }

        // NEW: Leave button for game screen
        function leaveGame() {
            showModal('leave-game-modal');
        }

        // NEW: Leave game confirmation modal
        function confirmLeaveGame() {
            hideModal('leave-game-modal');
            leaveRoom();
        }

        // === SPOTIFY INTEGRATION ===
        const spotifyClientId = '4e94cdc6f9c544f8a74b67e5bf31a5bb';
        // Use Render URL for production, fallback to localhost:8888 for local dev
        const spotifyRedirectUri = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://127.0.0.1:8888/callback'
            : 'https://jaceg22-github-io.onrender.com/callback';
        let spotifyAccessToken = null;
        let spotifyPlayer = null;
        let spotifyPlayerReady = false;
        let spotifyIsPremium = false;
        let spotifyCurrentTrack = null;
        let spotifyDeviceId = null;

        function showSpotifyPlayer() {
            const playerDivs = [
                document.getElementById('spotify-player'),
                document.getElementById('spotify-player-home')
            ];
            playerDivs.forEach(div => { if (div) div.style.display = 'block'; });
            // Show browse button after login
            document.getElementById('spotify-browse-btn').style.display = 'inline-block';
        }

        function showSpotifyPlayerUI() {
            const uiDivs = [
                document.getElementById('spotify-player-ui'),
                document.getElementById('spotify-player-ui-home')
            ];
            uiDivs.forEach(div => { if (div) div.style.display = 'block'; });
        }

        function hideSpotifyPlayerUI() {
            const uiDivs = [
                document.getElementById('spotify-player-ui'),
                document.getElementById('spotify-player-ui-home')
            ];
            uiDivs.forEach(div => { if (div) div.style.display = 'none'; });
        }

        function showSpotifyPremiumWarning(msg) {
            const warnings = [
                document.getElementById('spotify-premium-warning'),
                document.getElementById('spotify-premium-warning-home')
            ];
            warnings.forEach(div => {
                if (div) {
                    div.textContent = msg;
                    div.style.display = 'block';
                }
            });
        }
        function hideSpotifyPremiumWarning() {
            const warnings = [
                document.getElementById('spotify-premium-warning'),
                document.getElementById('spotify-premium-warning-home')
            ];
            warnings.forEach(div => { if (div) div.style.display = 'none'; });
        }

        function setupSpotifyButtons() {
            const loginBtns = [
                document.getElementById('spotify-login-btn'),
                document.getElementById('spotify-login-btn-home')
            ];
            loginBtns.forEach(btn => {
                if (btn) {
                    btn.onclick = function() {
                        const scope = 'streaming user-read-email user-read-private user-modify-playback-state user-read-playback-state';
                        const authUrl = `https://accounts.spotify.com/authorize?response_type=code&client_id=${spotifyClientId}&scope=${encodeURIComponent(scope)}&redirect_uri=${encodeURIComponent(spotifyRedirectUri)}`;
                        window.open(authUrl, 'spotify-login', 'width=500,height=700');
                    };
                }
            });
        }
        setupSpotifyButtons();

        window.addEventListener('message', (event) => {
            if (event.data && event.data.access_token) {
                spotifyAccessToken = event.data.access_token;
                showSpotifyPlayer();
                getSpotifyUserProfile();
                initializeSpotifyWebPlayback();
                showSuccess('Spotify connected!');
            }
        });

        function getSpotifyUserProfile() {
            fetch('https://api.spotify.com/v1/me', {
                headers: { 'Authorization': 'Bearer ' + spotifyAccessToken }
            })
            .then(res => res.json())
            .then(data => {
                spotifyIsPremium = data.product === 'premium';
                if (!spotifyIsPremium) {
                    showSpotifyPremiumWarning('Spotify Premium is required for in-browser playback. You can play 30s previews.');
                } else {
                    hideSpotifyPremiumWarning();
                }
            });
        }

        function initializeSpotifyWebPlayback() {
            if (!window.Spotify) {
                showSpotifyPremiumWarning('Spotify Web Playback SDK not loaded.');
                return;
            }
            if (!spotifyAccessToken) return;
            if (spotifyPlayer) {
                spotifyPlayer.disconnect();
                spotifyPlayer = null;
            }
            spotifyPlayer = new Spotify.Player({
                name: 'Game Collection Web Player',
                getOAuthToken: cb => { cb(spotifyAccessToken); },
                volume: 0.8
            });
            spotifyPlayer.addListener('ready', ({ device_id }) => {
                spotifyPlayerReady = true;
                spotifyDeviceId = device_id;
                showSpotifyPlayerUI();
            });
            spotifyPlayer.addListener('not_ready', () => {
                spotifyPlayerReady = false;
            });
            spotifyPlayer.addListener('player_state_changed', state => {
                if (!state) return;
                spotifyCurrentTrack = state.track_window.current_track;
                updateSpotifyTrackInfo();
            });
            spotifyPlayer.connect();
        }

        function updateSpotifyTrackInfo() {
            const infoDivs = [
                document.getElementById('spotify-track-info'),
                document.getElementById('spotify-track-info-home')
            ];
            if (spotifyCurrentTrack) {
                infoDivs.forEach(div => {
                    if (div) {
                        div.innerHTML = `<img src="${spotifyCurrentTrack.album.images[0]?.url}" style="height:40px;vertical-align:middle;margin-right:8px;">${spotifyCurrentTrack.name} - ${spotifyCurrentTrack.artists.map(a=>a.name).join(', ')}`;
                    }
                });
            } else {
                infoDivs.forEach(div => { if (div) div.textContent = ''; });
            }
        }

        function playSpotifyTrack() {
            if (!spotifyAccessToken) {
                showError('Connect Spotify first!');
                return;
            }
            if (spotifyIsPremium && spotifyPlayerReady && spotifyDeviceId) {
                fetch('https://api.spotify.com/v1/me/player/play?device_id=' + spotifyDeviceId, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + spotifyAccessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uris: ['spotify:track:3n3Ppam7vgaVa1iaRUc9Lp'] // Example track
                    })
                }).then(res => {
                    if (res.status === 204) {
                        showSuccess('Playing in browser!');
                    } else {
                        showError('Failed to play. Try opening Spotify on your device.');
                    }
                });
            } else {
                // Fallback: play preview
                playSpotifyPreview('3n3Ppam7vgaVa1iaRUc9Lp');
            }
        }

        function playSpotifyPreview(trackId) {
            // Play 30s preview using HTML5 audio
            fetch('https://api.spotify.com/v1/tracks/' + trackId, {
                headers: { 'Authorization': 'Bearer ' + spotifyAccessToken }
            })
            .then(res => res.json())
            .then(data => {
                if (data.preview_url) {
                    const audio = new Audio(data.preview_url);
                    audio.play();
                    showSpotifyPremiumWarning('Playing 30s preview. Upgrade to Premium for full playback.');
                } else {
                    showError('No preview available for this track.');
                }
            });
        }

        // Player controls
        function spotifyPlay() {
            if (spotifyIsPremium && spotifyPlayerReady) spotifyPlayer.resume();
        }
        function spotifyPause() {
            if (spotifyIsPremium && spotifyPlayerReady) spotifyPlayer.pause();
        }
        function spotifyNext() {
            if (spotifyIsPremium && spotifyPlayerReady) spotifyPlayer.nextTrack();
        }
        function spotifyPrev() {
            if (spotifyIsPremium && spotifyPlayerReady) spotifyPlayer.previousTrack();
        }
        document.getElementById('spotify-play-btn')?.addEventListener('click', spotifyPlay);
        document.getElementById('spotify-pause-btn')?.addEventListener('click', spotifyPause);
        document.getElementById('spotify-next-btn')?.addEventListener('click', spotifyNext);
        document.getElementById('spotify-prev-btn')?.addEventListener('click', spotifyPrev);
        document.getElementById('spotify-play-btn-home')?.addEventListener('click', spotifyPlay);
        document.getElementById('spotify-pause-btn-home')?.addEventListener('click', spotifyPause);
        document.getElementById('spotify-next-btn-home')?.addEventListener('click', spotifyNext);
        document.getElementById('spotify-prev-btn-home')?.addEventListener('click', spotifyPrev);

        // === SPOTIFY BROWSER MODAL ===
        function showSpotifyBrowser() {
            document.getElementById('spotify-browser-modal').classList.add('active');
            switchSpotifyTab('playlists');
            loadSpotifyPlaylists();
        }
        function hideSpotifyBrowser() {
            document.getElementById('spotify-browser-modal').classList.remove('active');
            document.getElementById('spotify-playlist-tracks').innerHTML = '';
        }
        document.getElementById('spotify-browse-btn').onclick = showSpotifyBrowser;
        function switchSpotifyTab(tab) {
            document.getElementById('spotify-tab-playlists').classList.remove('active');
            document.getElementById('spotify-tab-search').classList.remove('active');
            document.getElementById('spotify-playlists-tab').classList.remove('active');
            document.getElementById('spotify-search-tab').classList.remove('active');
            if (tab === 'playlists') {
                document.getElementById('spotify-tab-playlists').classList.add('active');
                document.getElementById('spotify-playlists-tab').classList.add('active');
            } else {
                document.getElementById('spotify-tab-search').classList.add('active');
                document.getElementById('spotify-search-tab').classList.add('active');
            }
        }
        // --- Playlists ---
        function loadSpotifyPlaylists() {
            const listDiv = document.getElementById('spotify-playlists-list');
            listDiv.innerHTML = 'Loading playlists...';
            fetch('https://api.spotify.com/v1/me/playlists?limit=50', {
                headers: { 'Authorization': 'Bearer ' + spotifyAccessToken }
            })
            .then(res => res.json())
            .then(data => {
                if (!data.items || data.items.length === 0) {
                    listDiv.innerHTML = '<p>No playlists found.</p>';
                    return;
                }
                let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;">';
                data.items.forEach(pl => {
                    html += `<div style="background:rgba(52,73,94,0.8);padding:1rem;border-radius:10px;text-align:center;cursor:pointer;" onclick="loadSpotifyPlaylistTracks('${pl.id}','${pl.name.replace(/'/g,"&#39;")}")">
                        <img src="${pl.images[0]?.url||''}" style="width:100px;height:100px;border-radius:8px;"><br>
                        <strong>${pl.name}</strong><br>
                        <span style="font-size:0.9em;opacity:0.7;">${pl.tracks.total} tracks</span>
                    </div>`;
                });
                html += '</div>';
                listDiv.innerHTML = html;
            });
        }
        function loadSpotifyPlaylistTracks(playlistId, playlistName) {
            const tracksDiv = document.getElementById('spotify-playlist-tracks');
            tracksDiv.innerHTML = `<h4>${playlistName}</h4>Loading tracks...`;
            fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100`, {
                headers: { 'Authorization': 'Bearer ' + spotifyAccessToken }
            })
            .then(res => res.json())
            .then(data => {
                if (!data.items || data.items.length === 0) {
                    tracksDiv.innerHTML = '<p>No tracks found.</p>';
                    return;
                }
                let html = '<div style="max-height:300px;overflow-y:auto;">';
                data.items.forEach(item => {
                    const t = item.track;
                    html += `<div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.5rem;">
                        <img src="${t.album.images[0]?.url||''}" style="width:40px;height:40px;border-radius:4px;">
                        <div style="flex:1;">
                            <strong>${t.name}</strong><br><span style="font-size:0.9em;opacity:0.7;">${t.artists.map(a=>a.name).join(', ')}</span>
                        </div>
                        <button class="btn btn-primary" onclick="playSpotifyTrackId('${t.id}')">‚ñ∂Ô∏è Play</button>
                        <button class="btn btn-secondary" onclick="queueSpotifyTrack('${t.id}')">‚ûï Queue</button>
                    </div>`;
                });
                html += '</div>';
                tracksDiv.innerHTML = html;
            });
        }
        // --- Search ---
        function searchSpotify() {
            const q = document.getElementById('spotify-search-input').value.trim();
            if (!q) return;
            const resultsDiv = document.getElementById('spotify-search-results');
            resultsDiv.innerHTML = 'Searching...';
            fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(q)}&type=track,artist,album&limit=20`, {
                headers: { 'Authorization': 'Bearer ' + spotifyAccessToken }
            })
            .then(res => res.json())
            .then(data => {
                let html = '';
                if (data.tracks && data.tracks.items.length > 0) {
                    html += '<h4>Tracks</h4>';
                    data.tracks.items.forEach(t => {
                        html += `<div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.5rem;">
                            <img src="${t.album.images[0]?.url||''}" style="width:40px;height:40px;border-radius:4px;">
                            <div style="flex:1;">
                                <strong>${t.name}</strong><br><span style="font-size:0.9em;opacity:0.7;">${t.artists.map(a=>a.name).join(', ')}</span>
                            </div>
                            <button class="btn btn-primary" onclick="playSpotifyTrackId('${t.id}')">‚ñ∂Ô∏è Play</button>
                            <button class="btn btn-secondary" onclick="queueSpotifyTrack('${t.id}')">‚ûï Queue</button>
                        </div>`;
                    });
                }
                if (data.artists && data.artists.items.length > 0) {
                    html += '<h4>Artists</h4>';
                    data.artists.items.forEach(a => {
                        html += `<div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.5rem;">
                            <img src="${a.images[0]?.url||''}" style="width:40px;height:40px;border-radius:4px;">
                            <div style="flex:1;">
                                <strong>${a.name}</strong>
                            </div>
                        </div>`;
                    });
                }
                if (data.albums && data.albums.items.length > 0) {
                    html += '<h4>Albums</h4>';
                    data.albums.items.forEach(al => {
                        html += `<div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.5rem;">
                            <img src="${al.images[0]?.url||''}" style="width:40px;height:40px;border-radius:4px;">
                            <div style="flex:1;">
                                <strong>${al.name}</strong><br><span style="font-size:0.9em;opacity:0.7;">${al.artists.map(a=>a.name).join(', ')}</span>
                            </div>
                        </div>`;
                    });
                }
                if (!html) html = '<p>No results found.</p>';
                resultsDiv.innerHTML = html;
            });
        }
        // --- Play/Queue helpers ---
        function playSpotifyTrackId(trackId) {
            if (!spotifyAccessToken) return;
            if (spotifyIsPremium && spotifyPlayerReady && spotifyDeviceId) {
                fetch('https://api.spotify.com/v1/me/player/play?device_id=' + spotifyDeviceId, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + spotifyAccessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ uris: ['spotify:track:' + trackId] })
                });
            } else {
                playSpotifyPreview(trackId);
            }
        }
        function queueSpotifyTrack(trackId) {
            if (!spotifyAccessToken || !spotifyIsPremium || !spotifyPlayerReady || !spotifyDeviceId) return;
            fetch('https://api.spotify.com/v1/me/player/queue?uri=spotify:track:' + trackId + '&device_id=' + spotifyDeviceId, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + spotifyAccessToken }
            });
        }
    </script>
</body>
</html>